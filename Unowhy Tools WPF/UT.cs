/*
            
            
              ."I!ii>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ii!I".
             "!>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>!"
            :>>iii>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>iii>>:
            iii>>>>>>>>>>iiiii>>>>>>>>>>>>>>>>>>>>>>>>>>iiiii>i>>>>>>>>>>>>>>>>>>>>>>>>iiiii>>>>>>>>>>>>>>>>>iii
            >>>>>>>>>>>ii><>>>>i>>>>>>>>>>>>>>>>>>>>>>ii>>><>ii>>>>>>>>>>>>>>>>>>>>>>ii>>><>i>>>>>>>>>>>>>>>>>>>
            >>>>>>>>>>>i~-----_<i>>>>>>>>>>>>>>>>>>>ii<_-----_>i>>>>>>>>>>>>>>>>>>>ii<_-----~i>>>>>>>>>>>>>>>>>>
            >>>>>>>>>>>>_-____?~I!>>>>>>>>>>>>>>>>>>>i+?_____?<I!>>>>>>>>>>>>>>>>>>>i+?____--lli>>>>>>>>>>>>>>>>
            >>>>>>>>>>>>______-~;II!>>>>>>>>>>>>>>>>>i~-_____->;II!>>>>>>>>>>>>>>>>>i~-______l;Ili>>>>>>>>>>>>>>
            >>>>>>>>>>>>+_____-<;IIII!>>>>>>>>>>>>>>>i~______->;IIII!>>>>>>>>>>>>>>>i~_______l;IIIli>>>>>>>>>>>>
            >>>>>>>>>>>>+_++++_<;IIIIII!>>>>>>>>>>>>>i~_+++++_>;IIIIII!>>>>>>>>>>>>>i~_++++++l;IIIIIli>>>>>>>>>>
            >>>>>>>>>>>>++++++_<;;;IIIIII!>>>>>>>>>>>i~_+++++_>;IIIIIIII!>>>>>>>>iiii~_++++++l;IIIIIIIli>>>>>>>>
            >>>>>>>>>>>>~+~~~~~~<ilII;;IIII!>>>>>>>>>i<+~~~~~+i;IIIIIIIIII!>>iii>>><~~~~~~~~~l;IIIIIIIIIli>>>>>>
            >>>>>>>>>>>>~~~~~~~~~+~~<ilII;;;I!i>>>>>ii<+~~~~~_i;IIIIIIIIII;I!>><<~~+~~~~~~~~+l;IIIIIIIIIIIli>>>>
            >>>>>>>>>>>><<~~~~<<<<<~~~~<>ilII;I!>>>>>>><>><<>iIIIIIIIII;IIli><~~~~<<<<<~~~~<iIIIIIIIIIIIIIIIli>>
            >>>>>>>>>>>iiii!i<<~<<<<<<<<<~<<>!lII!i>>>>iilI;I;IIIII;IIl!><<~<<<<<<<<~~<>i!lI;IIIIIIIIIIIIIIIIIli
            >>>>>>>>>>>>>>>ilII!i><<<<>>>>><<<<>i!l!i>i>>>ilIII;IIl!i><<<<>>>>><<<<>i!lI;;;IIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>i>>il;;Il!ii><>>>>>>>>><>ii>>>i>>>ill!i>><>>>>>>>><<>ii!lII;;IIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>ilI;;IIIl!ii>>iiiiiii>>>iiiii>>>>>iiiiiii>>ii!llII;IIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIl!iiiiiiiiiiiiiiiiiiiiiiiiii!!lIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIll!!ii!!!!!!!!!!!ii!!llIIIIIIIIIII::IIIIIIII::;IIIIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIlll!!!!!!!!!lllIIIIIIIIIIII::l~?l,;;;;:;-+l::IIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIlllllll!lIIIIIIIIIIIIIII-\uzYn}~ii<?tzcn\?lIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIlllllllIIIIIIIIIIIIIIIIfUzcczzvnxnccvuucni;IIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIlIIIIIlIIIIIIIIIIIIIIl,_XvcuucUCCJznxnnv1,IIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIII;:::ijcvvCpkdwwdaaZcrnr~:::;IIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIII;IIIIIIIIIIIIIII;>-]|ucucqoOf1}[}|JWMJjnx(?+>IIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIII;;;;;;IIIIIIIIII:/XccvunZ#Q]][[[]?+n%Mujrxxxfl;IIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIIIIIII:fzvununpWX_[[[]]]~|%%vjjjrrj!;IIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilI;IIIIIIIIIIIIIII;-|\rvuxUWWu-+~~<~(*$qfjrj|1[IIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIIII;::l?xnjXhB*mCJOo$%0ffj{i;::IIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIIIIII,-nrjjcOboohwYj/fj):;IIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIIII;[njrjfttttt//tftf(IIIIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIIIII}frxrr\}?-])tjff/)i;IIIIIIIIIIIIII
            >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>ilIIIIIIIIIIIII:l~[)_;:::::i{}_i;;IIIIIIIIIIIIIII
            >>>>>>>>>>>>i!!>>>>>>>>>>i!!>>>illllll!!!lllllli>>>>>ilIIIIIIIIIIIII:::;IIIIII;:::;IIIIIIIIIIIIIIIII
            >>>>>>>>>>>lJhwii>>>>>>>lXhwi>l(##MMMMaha#MMM#M/I<>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>Id$8!I!i>>>><IZ$&lII[CJJJCU&$@CJJJJJ[,li>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lw$M!;II!>>><I0$#l;I;,,"^^.m$*"`^^^^:IIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$M!;IIII!i<I0$Ml;IIllii!:q$#!IllllIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$M!;IIIIIIiI0$Ml;IIIIIIi;q$#l;IIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$M!;IIIIIII"Q$Ml;IIIIIII:q$#l;IIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$M!;IIIIIIl"L$Ml;IIIIIII,q$#l;IIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$M!IIIIIIIl"Q$Ml;IIIIIII,q$#l;IIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lq$Ml:;:::::;`L$Ml;IIIIIII,q$#l;IIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>lw$M~><<<<<<<l0$#l;IIIIIII,w$#l;IIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIIIII
            >>>>>>>>>>>Id$$$$$$$$$$$$$$8l;IIIIIII,d$&l;IIIIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIIIII
            iii>>>>>>>>i1\(|\\\\\\\\\||)IIIIIIIII;[|1IIIIIIIIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIIIIII
            :>>iii>>>>>>lI;,""""""""""",IIIIIIIIII,",IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIIIIIII^
             "!>>>>>>>>>><<<ilIIllllllllIIIIIIIIIIIlIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIIIIIIII;`
              ."I!ii>>>>>>>>>>!IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIli>>>>>>ilIIIIIIIII:,`




            iiiiiii>>>>>><<<<<<<<<<<<<<<<<<<<<<>>>>>>iiiiiiii!II!!!!i;     .'   :.
            "",,,,,::::I;:;;;;;;IIIIIIIIIIIIIIII;;;;:l:::,::^+qO:^"^;(     }- ~i^+~
            ......'````````^^^"^"^"""",:"",,,,"""""^,"^````` -@8".'.,} .`.` :-!j/ -~
            ''''```                 .....'...          ^"^^^ -$M,'`':1 "/f~;+ih$$x (
            '''```.|ucUYUUUUUUUUUUUUUJUJYcXJJUJUUUUUYvvI`^^:._$W,'`';{  ':"]<@$$$B.i~
            `''``` d$aXJJJJJJJCCJCCJCCCJk$&UCCCCJCCUZ$$~`I^,._$W:'`';?`[+`\ vQn/1- ^1<I.      ..`,,;.
            `''``^.Z@r     .. .'..'.`'` \@Q `''',.. <@@~"I",'-$W,'^';_ >[];          ^;i+>"  ~I:!I:`.
            `'````'w@r .   ..```:;;IlIl,j$Z,lIII!II"]$@l     >$M,```"X?iI    ....        ">_!lil,,;!!~~
            ````^^ d$kcYYYYYYYvv>,;;;;I"j$O"lII;!;;^]$$JunjxxC$B:`^,:zQ/                   .I,~|vQdk <?""
            ``````'fJCO00OOOOq$$["I;IIl"r$ZilIlI;;;,+wZpwM$@qwOL:`^,,f\{' ^~!^                u@$$@1;} -+
            ^^^^^""'    ..`` >@@],IllIl,r$m;llllIII;l:^` /@Z .^.^^^`^|1    ^!~`               .k$h_I[
                       ....` i@@],IlIIl,r$Z,!lIlIlII;;;I^r$w^:,"""`^^,.                        ;{l~<^\/_
            LQQLQLQQQQQQQQQ0Qw$$[,IIll!,n$q:!llllilIl;:I`n$p '::.'^^^     '[          ^<   .   .i~   :!.
            LLLLLLLLLLLLLQQQQLUU~:IIlll;{Jj;!l!<iIlI:",".[Lv_-"1X{ ^^      c1,^<,     +\^I?^ . \'+\~
                          ..''``:;;;IIli::;lllI;l::!~{_(jjt\)d[^-k:`^      liII11`  "  I!l'   I~ `;.
            ^^^^^""":;;::lI;llli!lii>i-_iillIl[|:|Yjjj~Y0";" {q. Yc ^           Iil>_.     >1tY(!
            `````^^,I,:,,ll:;;l!!li<>i<~ii!lli{Zn~ol:"":p+'`` Qx`:p/;                    `:tvU+i;
            ``````^^^,I;l!~>II;li<~!l;;l:!~lII^>h,UX "".jw,[(\XY^'i-,         `"^'      `?YX[it)
            `````^^^`Iill~_~>-~>!!+<<!<il!i;II!^xJ"k/|fjju>}_i,.^"' ` .'^;!i!<>li<iI!!l>~I.I|  `
            '``'```^"^"""",::IIl;:IlIIlII;I;;:I::k]~)]~;".`.'`^"^^^`;-<lII^
            """"",,,,,,,;I::::::I;;;;IIIIIIIII;I"}|`^",,::,,,","^"".<<
            ;IIIIIlIIllllllllllllllllllllllllllIl::llIIII;;;;;:::::,I[____________
            ]]]]]]]]]]]]]]][[][}}}}}}}}}}}}}}}}}}}}[[[[[[[[[[[[[[[[[]?]]]]]][[[](1
                                                                                                              



            
            ============================================================
            Name: Unowhy Tools (WPF)
            Description: The all-in-one tool for your Unowhy Y13 !
            Language: C#, XAML
            Framework: .NET 6.0
            Sub-Framework: Windows Presentation Foundation (WPF)
            Open Source: true
            License: MIT
            Author: STY1001
            Git: https://github.com/STY1001/Unowhy-Tools.git
            Contributable: true
            Stealable: false
            ============================================================
         

*/



using Microsoft.Win32;
using System;
using System.Diagnostics;
using System.IO;
using System.Resources;
using System.Runtime.InteropServices;
using System.ComponentModel;
using Unowhy_Tools_WPF.Views;
using System.Security.Principal;
using System.ServiceProcess;
using System.Runtime.CompilerServices;
using System.Windows.Media.Imaging;
using System.Net;
using System.Net.Http;
using System.Threading.Tasks;
using System.IO.Packaging;
using System.Windows.Controls;
using System.Windows.Media.Animation;
using System.Windows.Media;
using System.IO.Pipes;
using System.IO.Compression;
using System.Threading;
using System.Drawing;
using TaskScheduler = Microsoft.Win32.TaskScheduler;
using System.Windows;
using System.Windows.Interop;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Management;
using System.Windows.Documents;
using System.Windows.Threading;
using Unowhy_Tools_WPF.Views.Pages;
using System.Linq;
using System.Collections.Generic;
using System.Xml.Linq;
using System.Text.Json.Nodes;
using static System.Windows.Forms.VisualStyles.VisualStyleElement;
using Microsoft.VisualBasic.Devices;

namespace Unowhy_Tools
{
    public partial class UT
    {
        #region DLL
        [DllImport("DwmApi")]
        private static extern int DwmSetWindowAttribute(IntPtr hwnd, int attr, int[] attrValue, int attrSize);

        [DllImport("kernel32.dll", SetLastError = true)]
        private static extern bool Wow64DisableWow64FsRedirection(ref IntPtr ptr);

        [DllImport("kernel32.dll", SetLastError = true)]
        private static extern bool Wow64RevertWow64FsRedirection(IntPtr ptr);

        [DllImport("wininet.dll")]
        private static extern bool InternetGetConnectedState(out int state, int value);
        #endregion

        public static Data UTdata = new Data();

        public static string online_datas = "https://raw.githubusercontent.com/STY1001/Unowhy-Tools/master/Update/datas.json";
        public static string utpath = "C:\\Unowhy Tools";

        public static int verfull = 2901;
        public static string verbuild = "2153070624";
        public static bool verisdeb = false;

        public class version
        {

            public static int getverfull()
            {
                return verfull;
            }

            public static bool isdeb()
            {
                return verisdeb;
            }

            public static string getverbuild()
            {
                return verbuild;
            }

            public static async Task<bool> newver()
            {
                var web = new HttpClient();
                string newver = await UT.OnlineDatas.GetUpdates("utnewver");
                int newverint = Convert.ToInt32(newver);
                if (verfull < newverint)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }
        }

        public class anim
        {
            public static Grid _grid;
            public static Border _border;
            public static Grid _parentgrid;
            public static Border _parentborder;
            //public static Wpf.Ui.Controls.Button _button;

            public static async Task RegisterParent(Grid grid, Border border)
            {
                _parentborder = border;
                _parentgrid = grid;
            }

            public static async Task AnimParent(string animtype)
            {
                switch (animtype)
                {
                    case "zoomin":
                        await BorderZoomIn(_parentborder);
                        return;
                    case "zoomout":
                        await BorderZoomOut(_parentborder);
                        return;
                    case "zoomin2":
                        await BorderZoomIn2(_parentborder);
                        return;
                    case "zoomout2":
                        await BorderZoomOut2(_parentborder);
                        return;
                }
            }

            public static double fadespeed = 0.40;
            public static double zoomspeed = 0.45;
            public static async Task BorderZoomIn(Border border)
            {
                var fadeInAnimation = new DoubleAnimation
                {
                    From = 0,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(fadespeed),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseIn }
                };

                var zoomAnimation1 = new DoubleAnimation
                {
                    From = 0.9,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseOut }
                };

                var zoomAnimation2 = new DoubleAnimation
                {
                    From = 0.9,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseOut }
                };

                Storyboard.SetTarget(fadeInAnimation, border);
                Storyboard.SetTargetProperty(fadeInAnimation, new PropertyPath(UIElement.OpacityProperty));
                Storyboard.SetTarget(zoomAnimation1, border);
                Storyboard.SetTarget(zoomAnimation2, border);
                Storyboard.SetTargetProperty(zoomAnimation1, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleX)"));
                Storyboard.SetTargetProperty(zoomAnimation2, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleY)"));
                var storyboard = new Storyboard();
                storyboard.Children.Add(fadeInAnimation);
                storyboard.Children.Add(zoomAnimation1);
                storyboard.Children.Add(zoomAnimation2);
                storyboard.Begin();

                await Task.Delay(1000);

                await ResetZoom(border);
            }

            public static async Task BorderZoomOut(Border border)
            {
                var fadeInAnimation = new DoubleAnimation
                {
                    From = 0,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(fadespeed),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseIn }
                };

                var zoomAnimation1 = new DoubleAnimation
                {
                    From = 1.1,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseOut }
                };

                var zoomAnimation2 = new DoubleAnimation
                {
                    From = 1.1,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseOut }
                };

                Storyboard.SetTarget(fadeInAnimation, border);
                Storyboard.SetTargetProperty(fadeInAnimation, new PropertyPath(UIElement.OpacityProperty));
                Storyboard.SetTarget(zoomAnimation1, border);
                Storyboard.SetTarget(zoomAnimation2, border);
                Storyboard.SetTargetProperty(zoomAnimation1, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleX)"));
                Storyboard.SetTargetProperty(zoomAnimation2, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleY)"));
                var storyboard = new Storyboard();
                storyboard.Children.Add(fadeInAnimation);
                storyboard.Children.Add(zoomAnimation1);
                storyboard.Children.Add(zoomAnimation2);
                storyboard.Begin();

                await Task.Delay(1000);

                await ResetZoom(border);
            }

            public static async Task BorderZoomIn2(Border border)
            {
                var fadeInAnimation = new DoubleAnimation
                {
                    From = 1,
                    To = 0,
                    Duration = TimeSpan.FromSeconds(fadespeed),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
                };

                var zoomAnimation1 = new DoubleAnimation
                {
                    From = 1,
                    To = 1.1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseIn }
                };

                var zoomAnimation2 = new DoubleAnimation
                {
                    From = 1,
                    To = 1.1,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseIn }
                };

                Storyboard.SetTarget(fadeInAnimation, border);
                Storyboard.SetTargetProperty(fadeInAnimation, new PropertyPath(UIElement.OpacityProperty));
                Storyboard.SetTarget(zoomAnimation1, border);
                Storyboard.SetTarget(zoomAnimation2, border);
                Storyboard.SetTargetProperty(zoomAnimation1, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleX)"));
                Storyboard.SetTargetProperty(zoomAnimation2, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleY)"));
                var storyboard = new Storyboard();
                storyboard.Children.Add(fadeInAnimation);
                storyboard.Children.Add(zoomAnimation1);
                storyboard.Children.Add(zoomAnimation2);
                storyboard.Begin();

                await Task.Delay(1000);

                await ResetZoom(border);
            }

            public static async Task BorderZoomOut2(Border border)
            {
                var fadeInAnimation = new DoubleAnimation
                {
                    From = 1,
                    To = 0,
                    Duration = TimeSpan.FromSeconds(fadespeed),
                    EasingFunction = new QuadraticEase { EasingMode = EasingMode.EaseOut }
                };

                var zoomAnimation1 = new DoubleAnimation
                {
                    From = 1,
                    To = 0.9,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseIn }
                };

                var zoomAnimation2 = new DoubleAnimation
                {
                    From = 1,
                    To = 0.9,
                    Duration = TimeSpan.FromSeconds(zoomspeed),
                    EasingFunction = new CircleEase { EasingMode = EasingMode.EaseIn }
                };

                Storyboard.SetTarget(fadeInAnimation, border);
                Storyboard.SetTargetProperty(fadeInAnimation, new PropertyPath(UIElement.OpacityProperty));
                Storyboard.SetTarget(zoomAnimation1, border);
                Storyboard.SetTarget(zoomAnimation2, border);
                Storyboard.SetTargetProperty(zoomAnimation1, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleX)"));
                Storyboard.SetTargetProperty(zoomAnimation2, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleY)"));
                var storyboard = new Storyboard();
                storyboard.Children.Add(fadeInAnimation);
                storyboard.Children.Add(zoomAnimation1);
                storyboard.Children.Add(zoomAnimation2);
                storyboard.Begin();

                await Task.Delay(1000);

                await ResetZoom(border);
            }

            public static async Task ResetZoom(Border border)
            {
                var reset = new DoubleAnimation
                {
                    From = 1,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(0.5)
                };
                var reset2 = new DoubleAnimation
                {
                    From = 1,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(0.5)
                };
                var reset3 = new DoubleAnimation
                {
                    From = 1,
                    To = 1,
                    Duration = TimeSpan.FromSeconds(0.5)
                };
                Storyboard.SetTarget(reset, border);
                Storyboard.SetTargetProperty(reset, new PropertyPath(UIElement.OpacityProperty));
                Storyboard.SetTarget(reset2, border);
                Storyboard.SetTarget(reset3, border);
                Storyboard.SetTargetProperty(reset2, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleX)"));
                Storyboard.SetTargetProperty(reset3, new PropertyPath("(UIElement.RenderTransform).(ScaleTransform.ScaleY)"));
                var storyboard = new Storyboard();
                storyboard.Children.Add(reset);
                storyboard.Children.Add(reset2);
                storyboard.Children.Add(reset3);
                storyboard.Begin();
            }

            /*public static void TransitionBack(Grid grid)
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
                mainWindow.NavAnimLeft();
                _grid = grid;
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = 0;
                anim.To = 100;
                anim.Duration = TimeSpan.FromMilliseconds(300);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };

                TranslateTransform trans = new TranslateTransform();
                _grid.RenderTransform = trans;
                anim.Completed += setnormalBack;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }

            public static void BackBtnAnim(Wpf.Ui.Controls.Button btn)
            {
                _button = btn;
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = 0;
                anim.To = -150;
                anim.Duration = TimeSpan.FromMilliseconds(500);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };

                TranslateTransform trans = new TranslateTransform();
                _button.RenderTransform = trans;
                anim.Completed += setnormalBackBTN;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }
            
            public static void BackBtnAnimForw(Wpf.Ui.Controls.Button btn)
            {
                _button = btn;
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = -150;
                anim.To = 0;
                anim.Duration = TimeSpan.FromMilliseconds(500);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };

                TranslateTransform trans = new TranslateTransform();
                _button.RenderTransform = trans;
                anim.Completed += setnormalBackBTN;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }

            public static void setnormalBackBTN(object sender, EventArgs e)
            {
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = -150;
                anim.To = 0;
                anim.Duration = TimeSpan.FromMilliseconds(0);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };
                TranslateTransform trans = new TranslateTransform();
                _button.RenderTransform = trans;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }

            public static void setnormalBack(object sender, EventArgs e)
            {
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = -100;
                anim.To = 0;
                anim.Duration = TimeSpan.FromMilliseconds(300);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };

                TranslateTransform trans = new TranslateTransform();
                _grid.RenderTransform = trans;
                anim.Completed += setnormalAnim;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }

            public static void setnormalForw(object sender, EventArgs e)
            {
                DoubleAnimation anim = new DoubleAnimation();
                anim.From = 100;
                anim.To = 0;
                anim.Duration = TimeSpan.FromMilliseconds(300);
                anim.EasingFunction = new PowerEase() { EasingMode = EasingMode.EaseInOut, Power = 5 };

                TranslateTransform trans = new TranslateTransform();
                _grid.RenderTransform = trans;
                anim.Completed += setnormalAnim;
                trans.BeginAnimation(TranslateTransform.XProperty, anim);
            }

            public static void setnormalAnim(object sender, EventArgs e)
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
                mainWindow.NavAnimNormal();
            }*/
        }

        public class serv
        {
            public static async Task<bool> exist(string service)
            {
                Write2Log("Check " + service);
                string s = await RunReturn("sc", "query \"" + service + "\"");
                if (s.Contains("1060"))
                {
                    return false;
                }
                else
                {
                    return true;
                }
            }

            public static async Task stop(string service)
            {
                Write2Log("Stop " + service);
                await RunMin("net", "stop \"" + service + "\" /y");
            }

            public static async Task start(string service)
            {
                Write2Log("Start " + service);
                await RunMin("net", "start \"" + service + "\"");
            }

            public static async Task auto(string service)
            {
                Write2Log("Enable " + service);
                await RunMin("sc", "config \"" + service + "\" start=auto");
            }

            public static async Task dis(string service)
            {
                Write2Log("Disable " + service);
                await serv.stop(service);
                await RunMin("sc", "config \"" + service + "\" start=disabled");
            }

            public static async Task del(string service)
            {
                Write2Log("Delete " + service);
                await serv.stop(service);
                await RunMin("sc", "delete \"" + service + "\"");
            }
        }

        public class waitstatus
        {
            public async static Task open(string title, string img)
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
                if (mainWindow.WaitRoot.Visibility == Visibility.Collapsed)
                {
                    Write2Log("Open wait");
                }
                await mainWindow.ShowWait(title, img);
            }

            public async static Task close()
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
                Write2Log("Close wait");
                await mainWindow.HideWait();
            }
        }

        public class UTS
        {
            public static async Task<string> UTSmsg(string pipe, string msg)
            {
                Write2Log($"Message to UTS: Pipe:\"{pipe}\" Message:\"{msg}\"");
                string ret = "UTSerr";

                try
                {
                    using (NamedPipeClientStream pipeClient = new NamedPipeClientStream(".", pipe, PipeDirection.InOut, PipeOptions.Asynchronous))
                    {
                        await pipeClient.ConnectAsync(1000);
                        if (pipeClient.IsConnected)
                        {
                            using (var writer = new StreamWriter(pipeClient))
                            using (var reader = new StreamReader(pipeClient))
                            {
                                await writer.WriteLineAsync(msg);
                                await writer.FlushAsync();

                                if (pipeClient.IsConnected)
                                {
                                    ret = await reader.ReadLineAsync();
                                }
                            }
                        }
                    }
                }
                catch (Exception e)
                {

                }

                Write2Log($"Return: \"{ret}\"");
                return ret;
            }

            public static async Task UTScheck()
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
                await MainWindow.USS("Preparing UTS... (Checking)");
                string instdir = Directory.GetCurrentDirectory() + "\\Unowhy Tools Service";

                if (!Directory.Exists(instdir))
                {
                    Directory.CreateDirectory(instdir);
                }
                if (!File.Exists(instdir + "\\Unowhy Tools Service.exe"))
                {
                    if (await UT.CheckInternet())
                    {
                        await MainWindow.USSwB("Preparing UTS... (Downloading)");
                        string utemp = utpath + "\\Unowhy Tools\\Temps";
                        var progress = new System.Progress<double>();
                        var cancellationToken = new CancellationTokenSource();
                        progress.ProgressChanged += (sender, value) =>
                        {
                            mainWindow.SplashText.Text = "Preparing UTS... (Downloading) (" + value.ToString("##0.0") + "%)";
                        };
                        await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("utszip"), utemp + "\\service.zip", progress, cancellationToken.Token);
                        await MainWindow.USSwB("Preparing UTS... (Extracting)");
                        await Task.Delay(100);
                        ZipFile.ExtractToDirectory(utemp + "\\service.zip", instdir, true);
                        await Task.Delay(100);
                    }
                }
                string utspath = instdir + "\\Unowhy Tools Service.exe";

                if (await UT.serv.exist("UTS"))
                {
                    ServiceController sc = new ServiceController();
                    sc.ServiceName = "UTS";

                    if (sc.ServiceType.HasFlag(ServiceType.InteractiveProcess) && sc.ServiceType.HasFlag(ServiceType.Win32OwnProcess))
                    {

                    }
                    else
                    {
                        await UT.RunMin("sc", "config UTS type=own type=interact");
                        await MainWindow.USSwB("Preparing UTS... (Restarting)");
                        await UT.serv.stop("UTS");
                        await UT.serv.start("UTS");
                    }

                    if (sc.StartType == ServiceStartMode.Automatic)
                    {
                        if (sc.Status == ServiceControllerStatus.Running)
                        {
                            await MainWindow.USSwB("Preparing UTS... (Running)");

                        }
                        else
                        {
                            await UT.serv.start("UTS");
                            await MainWindow.USSwB("Preparing UTS... (Starting)");
                        }
                    }
                    else
                    {
                        await UT.serv.auto("UTS");
                        await UT.serv.start("UTS");
                        await MainWindow.USSwB("Preparing UTS... (Starting)");
                    }
                }
                else
                {
                    await MainWindow.USSwB("Preparing UTS... (Installing)");
                    await UT.RunMin("sc", $"create UTS binpath=\"\\\"{utspath}\\\"\" displayname=\"Unowhy Tools Service\" start=auto type=own type=interact");
                    await UT.serv.start("UTS");
                }

                if ((await UTSmsg("UTS", "GetVer")).Contains("UTSerr"))
                {
                    await MainWindow.USSwB("Preparing UTS... (Stopping)");
                    await UT.serv.stop("UTS");
                    await MainWindow.USSwB("Preparing UTS... (Downloading)");
                    Directory.Delete(instdir, true);
                    await Task.Delay(100);
                    Directory.CreateDirectory(instdir);
                    string utemp = utpath + "\\Unowhy Tools\\Temps";
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    progress.ProgressChanged += (sender, value) =>
                    {
                        mainWindow.SplashText.Text = "Preparing UTS... (Downloading) (" + value.ToString("##0.0") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("utszip"), utemp + "\\service.zip", progress, cancellationToken.Token);
                    await MainWindow.USSwB("Preparing UTS... (Extracting)");
                    await Task.Delay(100);
                    ZipFile.ExtractToDirectory(utemp + "\\service.zip", instdir, true);
                    await Task.Delay(100);
                    await MainWindow.USSwB("Preparing UTS... (Starting)");
                    await UT.serv.start("UTS");
                }

                await MainWindow.USS("Preparing UTS... (Checking Update)");
                await UT.UTS.UTSupdate();
            }

            public static async Task UTSupdate()
            {
                var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;

                if (await UT.CheckInternet())
                {
                    var web = new HttpClient();
                    string newver = await UT.OnlineDatas.GetUpdates("utsnewver");
                    newver = newver.Replace("\n", "").Replace("\r", "").Replace(" ", "");

                    string ver = await UT.UTS.UTSmsg("UTS", "GetVer");

                    if (!(newver == ver))
                    {
                        await MainWindow.USSwB("Preparing UTS... (" + ver + " => " + newver + ")");
                        await Task.Delay(1000);
                        await MainWindow.USSwB("Preparing UTS... (Stopping)");
                        await UT.serv.stop("UTS");
                        await MainWindow.USSwB("Preparing UTS... (Downloading)");
                        string instdir = Directory.GetCurrentDirectory() + "\\Unowhy Tools Service";
                        Directory.Delete(instdir, true);
                        await Task.Delay(100);
                        Directory.CreateDirectory(instdir);
                        string utemp = utpath + "\\Unowhy Tools\\Temps";
                        var progress = new System.Progress<double>();
                        var cancellationToken = new CancellationTokenSource();
                        progress.ProgressChanged += (sender, value) =>
                        {
                            mainWindow.SplashText.Text = "Preparing UTS... (Downloading) (" + value.ToString("##0.0") + "%)";
                        };
                        await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("utszip"), utemp + "\\service.zip", progress, cancellationToken.Token);
                        await MainWindow.USSwB("Preparing UTS... (Extracting)");
                        await Task.Delay(100);
                        ZipFile.ExtractToDirectory(utemp + "\\service.zip", instdir, true);
                        await Task.Delay(100);
                        await MainWindow.USSwB("Preparing UTS... (Starting)");
                        await UT.serv.start("UTS");
                    }
                }
            }
        }

        public class OnlineDatas
        {
            public static async Task<string> GetUrls(string name)
            {
                Write2Log("GetUrls: " + name);
                if (await UT.CheckInternet())
                {
                    string datasurl = online_datas;
                    HttpClient web = new HttpClient();
                    HttpResponseMessage rep = await web.GetAsync(datasurl);
                    if (rep.StatusCode == HttpStatusCode.OK)
                    {
                        string jsonContent = await web.GetStringAsync(datasurl);
                        dynamic jsonObject = JsonConvert.DeserializeObject(jsonContent);
                        if (jsonObject.urls != null && jsonObject.urls[name] != null)
                        {
                            string url = jsonObject.urls[name].ToString();
                            Write2Log("GetUrls result: " + name + " " + url);
                            return url;
                        }
                    }
                }
                return "null";
            }

            public static async Task<string> GetUpdates(string name)
            {
                Write2Log("GetUpdates: " + name);
                if (await UT.CheckInternet())
                {
                    string datasurl = online_datas;
                    HttpClient web = new HttpClient();
                    HttpResponseMessage rep = await web.GetAsync(datasurl);
                    if (rep.StatusCode == HttpStatusCode.OK)
                    {
                        string jsonContent = await web.GetStringAsync(datasurl);
                        dynamic jsonObject = JsonConvert.DeserializeObject(jsonContent);
                        if (jsonObject.updates != null && jsonObject.updates[name] != null)
                        {
                            string update = jsonObject.updates[name].ToString();
                            Write2Log("GetUpdates result: " + name + " " + update);
                            return update;
                        }
                    }
                }
                return "null";
            }

            public static async Task<string> GetStrings(string name)
            {
                Write2Log("GetStrings: " + name);
                if (await UT.CheckInternet())
                {
                    string datasurl = online_datas;
                    HttpClient web = new HttpClient();
                    HttpResponseMessage rep = await web.GetAsync(datasurl);
                    if (rep.StatusCode == HttpStatusCode.OK)
                    {
                        string jsonContent = await web.GetStringAsync(datasurl);
                        dynamic jsonObject = JsonConvert.DeserializeObject(jsonContent);
                        if (jsonObject.strings != null && jsonObject.strings[name] != null)
                        {
                            string str = jsonObject.strings[name].ToString();
                            Write2Log("GetStrings: " + name + " " + str);
                            return str;
                        }
                    }
                }
                return "null";
            }

            public static async Task<ImageSource> GetAvatars(string name)
            {
                Write2Log("GetAvatars: " + name);
                if (await UT.CheckInternet())
                {
                    string datasurl = online_datas;
                    HttpClient web = new HttpClient();
                    HttpResponseMessage rep = await web.GetAsync(datasurl);
                    if (rep.StatusCode == HttpStatusCode.OK)
                    {
                        string jsonContent = await web.GetStringAsync(datasurl);
                        dynamic jsonObject = JsonConvert.DeserializeObject(jsonContent);
                        if (jsonObject.avatars != null && jsonObject.avatars[name] != null)
                        {
                            string avatarsurl = jsonObject.avatars[name].ToString();
                            HttpResponseMessage rep2 = await web.GetAsync(avatarsurl);
                            if (rep2.StatusCode == HttpStatusCode.OK)
                            {
                                byte[] imageData = await web.GetByteArrayAsync(avatarsurl);
                                BitmapImage bitmapImage = new BitmapImage();
                                MemoryStream stream = new MemoryStream(imageData);
                                bitmapImage.BeginInit();
                                bitmapImage.CacheOption = BitmapCacheOption.OnLoad;
                                bitmapImage.StreamSource = stream;
                                bitmapImage.EndInit();
                                bitmapImage.Freeze();
                                return bitmapImage;
                            }
                        }
                    }
                }
                if (name == "sty1001")
                {
                    return GetImgSource("sty1001.png");
                }
                else if (name == "fgamer768")
                {
                    return GetImgSource("fgamer768.png");
                }
                else if (name == "nicospc")
                {
                    return GetImgSource("nico.png");
                }
                else
                {
                    return null;
                }
            }
        }

        public class Config
        {
            static string filePath = utpath + "\\Unowhy Tools\\settings.json";

            public static async Task<string> Get(string name)
            {
                Write2Log("Get Config: " + name);
                string jsonContent = File.ReadAllText(filePath);
                JObject jsonObject = JObject.Parse(jsonContent);

                if (jsonObject.TryGetValue(name, out var value))
                {
                    Write2Log("Get Config: " + name + " => " + value.ToString());
                    return value.ToString();
                }
                else
                {
                    Write2Log("Get Config: " + name + " is null");
                    return null;
                }
            }
            public static async Task Set(string name, string value)
            {
                Write2Log("Set Config: " + name + " => " + value);
                string jsonContent = File.ReadAllText(filePath);
                JObject jsonObject = JObject.Parse(jsonContent);

                jsonObject[name] = value;

                File.WriteAllText(filePath, jsonObject.ToString());
            }
        }

        public static async Task DeployDABack()
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            mainWindow.DeployDABack();
        }

        public static async Task DeployBack(Type type, Grid grid, Border border)
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            mainWindow.DeployBack(type, grid, border);
        }

        public static async Task UnDeployBack()
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            mainWindow.UnDeployBack();
        }

        public static async void NavigateTo(Type page)
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            mainWindow.Navigate(page);
        }

        public static async Task Cleanup()
        {
            /*
            List<string> oldfiles = new List<string>()
            {
                "temp\\adminusers.txt",
                "temp\\azure.txt",
                "temp\\ene.txt",
                "temp\\entuser.txt",
                "temp\\gitversion.txt",
                "temp\\hsmst.txt",
                "temp\\ifp.txt",
                "temp\\mf.txt",
                "temp\\model.txt",
                "temp\\os.txt",
                "temp\\pcname.txt",
                "temp\\rs.txt",
                "temp\\shell.txt",
                "temp\\username.txt",
                "azureleave.exe",
                "bootim.exe",
                "cuaboff.exe",
                "cuabon.exe",
                "delent.exe",
                "delentf.exe",
                "delhismserv.exe",
                "deloem.exe",
                "delridf.exe",
                "disadmin.exe",
                "dishis.exe",
                "enadmin.exe",
                "enhis.exe",
                "fixti.exe",
                "fullsoftinfo.txt",
                "fullpcinfo.txt",
                "getpcinfo.exe",
                "getsoftinfo.exe",
                "getuserinfo.exe",
                "langen.exe",
                "langfr.exe",
                "old2new",
                "rdti.exe",
                "reboot.exe",
                "rmdirhismgr.exe",
                "shell.exe",
                "starthis.exe",
                "stophis.exe",
                "Unowhy Tools Updater.exe",
                "utconfdel.exe",
                "utkeydel.exe",
                "version.txt",
                "winhelloent.exe",
                "winre.exe",
                "update.zip",
                "delhisqool.exe",
                "ene.txt",
                "model.txt",
                "os.txt",
                "pcname.txt",
                "tversion.txt",
                "username.txt",
                "clog.html",
                "fr.resx",
                "en.resx",
                "UTwait.exe",
                "UTsplash.exe",
                "7z.dll",
                "7zip.exe"
            };
            
            foreach(string file in oldfiles)
            {
                mainWindow.SplashText.Text = "Cleanup... (Checking)";
                mainWindow.SplashBar.Value++;
                await Task.Delay(1);
                if (File.Exists(file))
                {
                    mainWindow.SplashText.Text = "Cleanup... (" + file + ")";
                    File.Delete(file);
                }
            }
            */

            await MainWindow.USS("Cleanup... (Checking)");
            if (Directory.Exists("temp"))
            {
                await MainWindow.USSwB("Cleanup... (\\temp)");
                Directory.Delete("temp", true);
            }
            await MainWindow.USS("Cleanup... (Checking)");
            if (Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Drivers"))
            {
                await MainWindow.USSwB("Cleanup... (%temp%\\Unowhy Tools\\Temps\\Drivers)");
                Directory.Delete(utpath + "\\Unowhy Tools\\Temps\\Drivers", true);
            }
            if (Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Service"))
            {
                await MainWindow.USSwB("Cleanup... (%temp%\\Unowhy Tools\\Temps\\Service)");
                Directory.Delete(utpath + "\\Unowhy Tools\\Temps\\Service", true);
            }
            if (Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Update"))
            {
                await MainWindow.USSwB("Cleanup... (%temp%\\Unowhy Tools\\Temps\\Update)");
                Directory.Delete(utpath + "\\Unowhy Tools\\Temps\\Update", true);
            }
        }

        public static async Task SendCrashReport(string crashid, Exception e, string apilink)
        {
            Guid uuid = Guid.NewGuid();
            string uuidString = uuid.ToString();

            if (await UT.Config.Get("ID") != null) uuidString = await UT.Config.Get("ID");

            if (await UT.CheckInternet())
            {
                using (HttpClient client = new HttpClient())
                {
                    try
                    {
                        string url = $"{apilink}/crash";
                        var crashData = new
                        {
                            id = uuidString,
                            version = UT.version.getverfull().ToString().Insert(2, "."),
                            build = UT.version.getverbuild().ToString(),
                            utsversion = await UT.UTS.UTSmsg("UTS", "GetVer"),
                            isdeb = UT.version.isdeb().ToString().ToLower(),
                            crashid = crashid,
                            message = e.Message.Replace("\"", "\\\"").Replace("\\", "\\\\")
                        };
                        string jsonData = JsonConvert.SerializeObject(crashData);
                        Write2Log($"Sending crash report (step 1/2) to \"{url}\" with \"{jsonData}\"");
                        StringContent content = new StringContent(jsonData, System.Text.Encoding.UTF8, "application/json");
                        HttpResponseMessage response = await client.PostAsync(url, content);
                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            Write2Log($"Sent! Response: {await response.Content.ReadAsStringAsync()} ({response.StatusCode})");
                        }
                        else
                        {
                            Write2Log($"Error! Response: {await response.Content.ReadAsStringAsync()} ({response.StatusCode})");
                        }
                        url = $"{apilink}/crash/logs";
                        string logs = UTdata.Logs; // ou File.ReadAllText(utpath + "\\Unowhy Tools\\Logs\\UT_Logs.txt");
                        client.DefaultRequestHeaders.Add("crashid", crashid);
                        Write2Log($"Sending crash report (step 2/2) to \"{url}\"");
                        content = new StringContent(logs, System.Text.Encoding.UTF8, "text/plain");
                        response = await client.PostAsync(url, content);
                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            Write2Log($"Sent! Response: {await response.Content.ReadAsStringAsync()} ({response.StatusCode})");
                        }
                        else
                        {
                            Write2Log($"Error! Response: {await response.Content.ReadAsStringAsync()} ({response.StatusCode})");
                        }
                    }
                    catch (Exception fail)
                    {
                        Write2Log("Failed: " + fail.Message);
                    }

                }
            }
        }

        public static async Task SendAction(string action)
        {
            string uuidString = "null";

            if (await UT.Config.Get("ID") != null) uuidString = await UT.Config.Get("ID");

            if (await UT.CheckInternet())
            {
                using (HttpClient client = new HttpClient())
                {
                    try
                    {
                        string url = await UT.OnlineDatas.GetUrls("api") + "/usage";
                        var data = new
                        {
                            id = uuidString,
                            action = action
                        };
                        string jsonData = JsonConvert.SerializeObject(data);
                        Write2Log($"Sending action \"{action}\" to \"{url}\" with \"{jsonData}\"");
                        StringContent content = new StringContent(jsonData, System.Text.Encoding.UTF8, "application/json");
                        HttpResponseMessage response = await client.PostAsync(url, content);
                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            Write2Log("Sent! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                        else
                        {
                            Write2Log("Error! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                    }
                    catch (Exception fail)
                    {
                        Write2Log("Failed: " + fail.Message);
                    }

                }
            }
        }

        public static async Task SendStats(string launchmode)
        {
            Guid uuid = Guid.NewGuid();
            string uuidString = uuid.ToString();

            if (await UT.Config.Get("ID") == null)
            {
                await UT.Config.Set("ID", uuidString);
            }

            string idString = await UT.Config.Get("ID");
            string langString = await UT.Config.Get("Lang");

            bool tray;
            TaskScheduler.TaskService taskService = new TaskScheduler.TaskService();
            TaskScheduler.Task uttask = taskService.GetTask("Unowhy Tools Tray Launch");
            if (uttask != null)
            {
                if (uttask.Definition.Settings.Enabled)
                {
                    tray = true;
                }
                else
                {
                    tray = false;
                }
            }
            else
            {
                tray = false;
            }

            bool wifi;
            if ((await UT.UTS.UTSmsg("UTSW", "GetWS")).Contains("True"))
            {
                wifi = true;
            }
            else
            {
                wifi = false;
            }

            string model = "Unknown";
            string sku = GetWMI("Win32_ComputerSystem", "SystemSKUNumber");
            model = await UT.GetModelWithSKU(sku);

            bool weirdpc = false;
            if (model == "Unknown")
            {
                weirdpc = true;
            }

            List<string> defaultosfile = new List<string>()
            {
                "C:\\Windows\\ver.txt",
                "C:\\Windows\\version_gpo.txt",
                "C:\\Windows\\version_master.txt"
            };

            bool defaultos = false;
            foreach (string file in defaultosfile)
            {
                if (File.Exists(file))
                {
                    defaultos = true;
                }
            }

            string osversion = GetWMI("Win32_OperatingSystem", "Caption");
            if (await UT.CheckInternet())
            {
                using (HttpClient client = new HttpClient())
                {
                    try
                    {
                        string url = await UT.OnlineDatas.GetUrls("api");
                        var data = new
                        {
                            id = idString.ToString(),
                            version = UT.version.getverfull().ToString().Insert(2, "."),
                            build = UT.version.getverbuild().ToString(),
                            utsversion = await UT.UTS.UTSmsg("UTS", "GetVer"),
                            lang = langString.ToString(),
                            launchmode = launchmode.ToString(),
                            trayena = tray.ToString().ToLower(),
                            isdeb = UT.version.isdeb().ToString().ToLower(),
                            wifiena = wifi.ToString().ToLower(),
                            pcmodel = model.ToString(),
                            defaultos = defaultos.ToString().ToLower(),
                            osversion = osversion.ToString(),
                            weirdpc = weirdpc.ToString().ToLower()
                        };
                        string jsonData = JsonConvert.SerializeObject(data);
                        Write2Log($"Sending Stats to \"{url}\" with \"{jsonData}\"");
                        StringContent content = new StringContent(jsonData, System.Text.Encoding.UTF8, "application/json");
                        HttpResponseMessage response = await client.PostAsync(url, content);

                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            Write2Log("Sent! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                        else
                        {
                            Write2Log("Error! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                    }
                    catch (Exception e)
                    {
                        Write2Log("Failed: " + e);
                    }

                }
            }
        }

        public static async Task SendCheck()
        {
            string uuidString = "null";

            if (await UT.Config.Get("ID") != null) uuidString = await UT.Config.Get("ID");

            if (await UT.CheckInternet())
            {
                using (HttpClient client = new HttpClient())
                {
                    try
                    {
                        string url = await UT.OnlineDatas.GetUrls("api") + "/check";
                        var data = new
                        {
                            id = uuidString,
                            check = new
                            {
                                HSMRunning = UTdata.HSMRunning,
                                HSMEnabled = UTdata.HSMEnabled,
                                HSMExist = UTdata.HSMExist,
                                HSMExeExist = UTdata.HSMExeExist,
                                AAD = UTdata.AAD,
                                Admin = UTdata.Admin,
                                RIDFFolderExist = UTdata.RIDFFolderExist,
                                ENTFolderExist = UTdata.ENTFolderExist,
                                OEMFolderExist = UTdata.OEMFolderExist,
                                TIFolderExist = UTdata.TIFolderExist,
                                HSQMFolderExist = UTdata.HSQMFolderExist,
                                HSQFolderExist = UTdata.HSQFolderExist,
                                ENTUser = UTdata.ENTUser,
                                WHE = UTdata.WHE,
                                TIStartup = UTdata.TIStartup,
                                BIM = UTdata.BIM,
                                BCD = UTdata.BCD,
                                ShellOK = UTdata.ShellOK,
                                TaskMGR = UTdata.TaskMGR,
                                LockA = UTdata.LockA,
                                CamOver = UTdata.CamOver,
                                VerbStat = UTdata.VerbStat,
                                WinRE = UTdata.WinRE,
                                EdgeInstalled = UTdata.EdgeInstalled,
                                NoEdgeReg = UTdata.NoEdgeReg,
                                WinDefEnabled = UTdata.WinDefEnabled,
                                RIDFCertInstalled = UTdata.RIDFCertInstalled
                            }
                        };
                        string jsonData = JsonConvert.SerializeObject(data);
                        Write2Log("Sending check to \"" + url + "\" with \"" + jsonData + "\"");
                        StringContent content = new StringContent(jsonData, System.Text.Encoding.UTF8, "application/json");
                        HttpResponseMessage response = await client.PostAsync(url, content);
                        if (response.StatusCode == HttpStatusCode.OK)
                        {
                            Write2Log("Sent! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                        else
                        {
                            Write2Log("Error! Response:" + response.Content + "(" + response.StatusCode + ")");
                        }
                    }
                    catch (Exception fail)
                    {
                        Write2Log("Failed: " + fail.Message);
                    }

                }
            }
        }

        public static Dictionary<string, string> skumodel = new Dictionary<string, string>
        {
            { "Y13G113S4EI", "Y13 Gen 1 2023 IDF" },
            { "Y13G012S4EI", "Y13 Gen 1 2022 IDF" },
            { "Y13G011S4EI", "Y13 Gen 1 2021 IDF" },
            { "Y13G010S4EI", "Y13 Gen 1 2020 IDF" },
            { "Y13G002S4EI", "Y13 Gen 1 2019 IDF" },
            { "Y13G113S4E", "Y13 Gen 1 2023" },
            { "Y13G012S4E", "Y13 Gen 1 2022" },
            { "Y13G011S4E", "Y13 Gen 1 2021" },
            { "Y13G010S4E", "Y13 Gen 1 2020" },
            { "Y13G002S4E", "Y13 Gen 1 2019" },
            { "Y14G310S2MI", "Y14 Plus i3 IDF" },
            { "Y14G520S2MI", "Y14 Plus i5 IDF" },
            { "Y14G310S2M", "Y14 Plus i3" },
            { "Y14G520S2M", "Y14 Plus i5" },
            { "Y11G001S4E", "Y11 360 Gen 1" },
            { "Y11G201S2M", "Y11 360 Gen 2" },
            { "OPSG310S2M", "Y5OPS i3" },
            { "OPSG530S2M", "Y5OPS i5" },
            { "Y13G201S4EI", "Y13 Gen 2 2024 IDF" },
            { "Y13G201S4E", "Y13 Gen 2 2024" },
            { "STYY13U", "Y13 Ultimate" },
            { "STYY5OPSI5", "Y5OPS i5" }
        };
        public static async Task<string> GetModelWithSKU(string sku)
        {
            sku = sku.Replace(" ", "").Replace("\n", "").Replace("\r", "");
            if (skumodel.ContainsKey(sku)) return skumodel[sku];
            else return "Unknown";
        }

        public static async Task TrayCheck()
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            await MainWindow.USS("Preparing Tray... (Checking)");
            if (await CheckTray())
            {

            }
            else
            {
                TaskScheduler.TaskService taskService = new TaskScheduler.TaskService();

                TaskScheduler.Task uttask = taskService.GetTask("Unowhy Tools Tray Launch");
                if (uttask == null)
                {
                    await MainWindow.USSwB("Preparing Tray... (Creating)");

                    try
                    {
                        TaskScheduler.TaskDefinition taskDefinition = taskService.NewTask();
                        taskDefinition.RegistrationInfo.Date = DateTime.Now;
                        taskDefinition.RegistrationInfo.Author = "Unowhy Tools";
                        taskDefinition.RegistrationInfo.Description = "Launch Unowhy Tools Tray at user logon. If your account isn't set as admin, tray startup can fail. Go to Unowhy Tools and set your account as admin.";
                        taskDefinition.RegistrationInfo.URI = @"\STY1001\Unowhy Tools\Unowhy Tools Tray Launch";
                        taskDefinition.Principal.GroupId = new SecurityIdentifier("S-1-5-32-544").ToString();
                        taskDefinition.Principal.RunLevel = TaskScheduler.TaskRunLevel.Highest;
                        taskDefinition.Settings.DisallowStartIfOnBatteries = false;
                        taskDefinition.Settings.StopIfGoingOnBatteries = false;
                        taskDefinition.Settings.AllowHardTerminate = true;
                        taskDefinition.Settings.StartWhenAvailable = true;
                        taskDefinition.Settings.RunOnlyIfNetworkAvailable = false;
                        taskDefinition.Settings.IdleSettings.StopOnIdleEnd = true;
                        taskDefinition.Settings.IdleSettings.RestartOnIdle = false;
                        taskDefinition.Settings.Enabled = true;
                        taskDefinition.Settings.Hidden = false;
                        taskDefinition.Settings.RunOnlyIfIdle = false;
                        taskDefinition.Settings.DisallowStartOnRemoteAppSession = false;
                        taskDefinition.Settings.UseUnifiedSchedulingEngine = true;
                        taskDefinition.Settings.WakeToRun = false;
                        taskDefinition.Settings.ExecutionTimeLimit = TimeSpan.Zero;
                        taskDefinition.Settings.Priority = System.Diagnostics.ProcessPriorityClass.Normal;
                        taskDefinition.Triggers.Add(new TaskScheduler.LogonTrigger { Enabled = true });
                        taskDefinition.Actions.Add(new TaskScheduler.ExecAction(Process.GetCurrentProcess().MainModule.FileName, "-tray", Directory.GetCurrentDirectory()));
                        taskService.RootFolder.RegisterTaskDefinition(@"Unowhy Tools Tray Launch", taskDefinition);
                    }
                    catch
                    {

                    }

                    try
                    {
                        await Task.Delay(1000);
                        await MainWindow.USSwB("Preparing Tray... (Launching)");
                        taskService = new TaskScheduler.TaskService();
                        uttask = taskService.GetTask("Unowhy Tools Tray Launch");
                        uttask.Run();
                    }
                    catch
                    {
                        await MainWindow.USSwB("Preparing Tray... (Waiting)");
                        await Task.Delay(5000);
                        await MainWindow.USSwB("Preparing Tray... (Launching)");
                        taskService = new TaskScheduler.TaskService();
                        uttask = taskService.GetTask("Unowhy Tools Tray Launch");
                        uttask.Run();
                    }
                }
                else
                {
                    if (uttask.Definition.Settings.Enabled)
                    {
                        await MainWindow.USSwB("Preparing Tray... (Launching)");
                        uttask.Run();
                    }
                }
            }
        }

        public static async Task<bool> FirstStart()
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            await MainWindow.USS("Checking... (Folder and file)");

            if (!Directory.Exists(utpath + "\\Unowhy Tools Service"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools Service");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools Service\\WifiXml"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools Service\\WifiXml");
            }

            if (!File.Exists(utpath + "\\Unowhy Tools Service\\serial.txt"))
            {
                if (File.Exists("C:\\UTSConfig\\serial.txt"))
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\serial.txt", File.ReadAllText("C:\\UTSConfig\\serial.txt"));
                }
                else
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\serial.txt", "Null");
                }
            }

            if (!File.Exists(utpath + "\\Unowhy Tools Service\\wifisync.txt"))
            {
                if (File.Exists("C:\\UTSConfig\\wifisync.txt"))
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\wifisync.txt", File.ReadAllText("C:\\UTSConfig\\wifisync.txt"));
                }
                else
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\wifisync.txt", "True");
                }
            }

            if (!File.Exists(utpath + "\\Unowhy Tools Service\\disablewd.txt"))
            {
                if (File.Exists("C:\\UTSConfig\\disablewd.txt"))
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\disablewd.txt", File.ReadAllText("C:\\UTSConfig\\disablewd.txt"));
                }
                else
                {
                    File.WriteAllText(utpath + "\\Unowhy Tools Service\\disablewd.txt", "False");
                }
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Logs"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Logs");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Update"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\Update");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Drivers"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\Drivers");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\WebView2"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\WebView2");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Service"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\Service");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\Edge"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\Edge");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\AMI"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\AMI");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\AMI\\AFU"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\AMI\\AFU");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\AMI\\AMIDE"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\AMI\\AMIDE");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\AMI\\IFPT"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\AMI\\IFPT");
            }

            if (!Directory.Exists(utpath + "\\Unowhy Tools\\Temps\\AMI\\ChangeLogo"))
            {
                Directory.CreateDirectory(utpath + "\\Unowhy Tools\\Temps\\AMI\\ChangeLogo");
            }

            if (!File.Exists(utpath + "\\Unowhy Tools\\Logs\\UT_Logs.txt"))
            {
                var f = File.CreateText(utpath + "\\Unowhy Tools\\Logs\\UT_Logs.txt");
                f.Close();
                Write2Log("============");
                Write2Log("Unowhy Tools");
                Write2Log(" by STY1001 ");
                Write2Log("============");
                Write2Log("");
                Write2Log("Start of logs, logs are saved locally and can help to fix issues");
                Write2Log("If you have an issue, please, open an issue on Github and give me logs to help you");
                Write2Log("You can cleanup logs on UT's settings");
                Write2Log("Last logs are on bottom\n\n\n");
            }

            if (!File.Exists(utpath + "\\Unowhy Tools\\settings.json"))
            {
                File.WriteAllText(utpath + "\\Unowhy Tools\\settings.json", "{\n  \"name\":\"value\"\n}");

                await Config.Set("OnlineData", "https://raw.githubusercontent.com/STY1001/Unowhy-Tools/master/Update/datas.json");

                RegistryKey keyut = Registry.CurrentUser.OpenSubKey(@"Software\STY1001\Unowhy Tools", true);
                if (keyut != null)
                {
                    await Config.Set("ID", keyut.GetValue("ID").ToString());
                    await Config.Set("UpdateStart", keyut.GetValue("UpdateStart").ToString());
                    await Config.Set("Lang", keyut.GetValue("Lang").ToString());
                    await Config.Set("Init", keyut.GetValue("Init2").ToString());
                    await Config.Set("QLtaskpath", keyut.GetValue("QLtaskpath").ToString());
                    await Config.Set("QLtaskicon", keyut.GetValue("QLtaskicon").ToString());
                    await Config.Set("QLtasklab", keyut.GetValue("QLtasklab").ToString());
                    await Config.Set("QLcmdpath", keyut.GetValue("QLcmdpath").ToString());
                    await Config.Set("QLcmdicon", keyut.GetValue("QLcmdicon").ToString());
                    await Config.Set("QLcmdlab", keyut.GetValue("QLcmdlab").ToString());
                    await Config.Set("QLregpath", keyut.GetValue("QLregpath").ToString());
                    await Config.Set("QLregicon", keyut.GetValue("QLregicon").ToString());
                    await Config.Set("QLreglab", keyut.GetValue("QLreglab").ToString());
                    await Config.Set("QLgppath", keyut.GetValue("QLgppath").ToString());
                    await Config.Set("QLgpicon", keyut.GetValue("QLgpicon").ToString());
                    await Config.Set("QLgplab", keyut.GetValue("QLgplab").ToString());
                }
                else
                {
                    await Config.Set("UpdateStart", "1");
                    await Config.Set("Lang", "EN");
                    await Config.Set("Init", "0");
                    await Config.Set("QLtaskpath", "default");
                    await Config.Set("QLtaskicon", "default");
                    await Config.Set("QLtasklab", "default");
                    await Config.Set("QLcmdpath", "default");
                    await Config.Set("QLcmdicon", "default");
                    await Config.Set("QLcmdlab", "default");
                    await Config.Set("QLregpath", "default");
                    await Config.Set("QLregicon", "default");
                    await Config.Set("QLreglab", "default");
                    await Config.Set("QLgppath", "default");
                    await Config.Set("QLgpicon", "default");
                    await Config.Set("QLgplab", "default");
                }
            }

            if (await UT.Config.Get("Init") == "1")
            {
                return false;
            }
            else
            {
                return true;
            }

        }

        public static async Task<bool> CheckTray()
        {
            /*bool trayrun = false;
            string tl = await RunReturn("powershell", "Get-WmiObject Win32_Process -Filter \"name = 'Unowhy Tools.exe'\" | Select-Object CommandLine");
            if (tl.Contains("-tray"))
            {
                trayrun = true;
                Write2Log("UT Tray is already running");
            }
            else
            {
                Write2Log("UT Tray is not running");
            }*/

            string UTTrep = await UTS.UTSmsg("UTT", "Ping");
            if (UTTrep == "Pong")
            {
                Write2Log("UT Tray is already running");
                return true;
            }
            else
            {
                Write2Log("UT Tray is not running");
                return false;
            }
        }

        public static async Task<long> FolderSizeGet(string path)
        {
            try
            {
                long size = 0;
                DirectoryInfo directoryInfo = new DirectoryInfo(path);

                await Task.Run(() =>
                {
                    FileInfo[] files = directoryInfo.GetFiles("*", SearchOption.AllDirectories);

                    foreach (FileInfo file in files)
                    {
                        Interlocked.Add(ref size, file.Length);
                    }
                });
                return size;
            }
            catch
            {
                long size = 0;
                return size;
            }
        }

        public static async Task<string> FolderSizeString(string directoryPath)
        {
            long size = await FolderSizeGet(directoryPath);
            string rep = "0.00 B";
            rep = FormatSize(size);
            return rep;
        }

        public static string FormatSize(long byteSize)
        {
            const int scale = 1024;
            string[] orders = { "GB", "MB", "KB", "B" };
            long max = (long)Math.Pow(scale, orders.Length - 1);

            foreach (string order in orders)
            {
                if (byteSize > max)
                    return string.Format("{0:0.00} {1}", (double)byteSize / max, order);

                max /= scale;
            }

            return "0.00 B";
        }

        public static void Delay(int Time_delay)
        {
            int i = 0;
            System.Timers.Timer _delayTimer = new System.Timers.Timer();
            _delayTimer.Interval = Time_delay;
            _delayTimer.AutoReset = false;
            _delayTimer.Elapsed += (s, args) => i = 1;
            _delayTimer.Start();
            while (i == 0) { };
        }

        public static async Task<string> RunReturn(string file, string args)
        {
            IntPtr wow64Value = IntPtr.Zero;
            Wow64DisableWow64FsRedirection(ref wow64Value);

            Write2Log("RunReturn " + file + " " + args);

            string output = await Task.Run(() =>
            {
                Process get = new Process();
                get.StartInfo.FileName = file;
                get.StartInfo.Arguments = args;
                get.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                get.StartInfo.UseShellExecute = false;
                get.StartInfo.RedirectStandardOutput = true;
                get.StartInfo.CreateNoWindow = true;
                get.Start();
                get.WaitForExit();
                return get.StandardOutput.ReadToEnd();
            });

            Write2Log("Done RunReturn " + file + " " + args + " => " + output);

            return output;
        }

        public static string GetLine(string text, int line)
        {
            int line2 = line - 1;
            var lines = text.Split('\n');
            return lines[line2].Replace("\n", "").Replace("\r", "");
        }

        public static ResXResourceSet resxLang;
        public static async Task LangConfig()
        {
            string exepath = Process.GetCurrentProcess().MainModule.FileName;
            string wdpath = Path.GetDirectoryName(exepath);
            try
            {


                string lang = await UT.Config.Get("Lang");
                if (lang == "EN")
                {
                    resxLang = new ResXResourceSet($"{wdpath}\\lang\\en.resx");
                }
                else if (lang == "FR")
                {
                    resxLang = new ResXResourceSet($"{wdpath}\\lang\\fr.resx");
                }
                else
                {
                    resxLang = new ResXResourceSet($"{wdpath}\\lang\\en.resx");
                }
            }
            catch
            {
                resxLang = new ResXResourceSet($"{wdpath}\\lang\\en.resx");
            }
        }

        public static async Task<string> GetLang(string name)
        {
            if (resxLang == null)
            {
                await LangConfig();
            }
            Write2Log("Get lang " + name + " => " + resxLang.GetString(name));
            return resxLang.GetString(name);
        }

        public async static Task RunMin(string file, string args)
        {
            IntPtr wow64Value = IntPtr.Zero;
            Wow64DisableWow64FsRedirection(ref wow64Value);
            Write2Log("RunMin " + file + " " + args);

            await Task.Run(() =>
            {
                Process p = new Process();
                p.StartInfo.FileName = file;
                p.StartInfo.Arguments = args;
                p.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
                p.StartInfo.CreateNoWindow = true;
                p.Start();
                p.WaitForExit();
            });

            Write2Log("Done RunMin " + file + " " + args);
        }

        public static void Write2Log(string log)
        {
            UTdata.Logs = UTdata.Logs + (DateTime.Now.ToString() + " : " + log + Environment.NewLine);
            if (UTdata.RunConsole)
            {
                Console.WriteLine(DateTime.Now.ToString() + " : " + log);
            }
            if (verisdeb)
            {
                Debug.WriteLine(DateTime.Now.ToString() + " : " + log);
            }
            try
            {
                if (File.Exists(utpath + "\\Unowhy Tools\\Logs\\UT_Logs.txt"))
                {
                    File.AppendAllText(utpath + "\\Unowhy Tools\\Logs\\UT_Logs.txt", DateTime.Now.ToString() + " : " + log + Environment.NewLine);
                }
            }
            catch { }
        }

        public static void applylang_global()
        {

        }

        public static bool CheckAdmin()
        {
            WindowsIdentity identity = WindowsIdentity.GetCurrent();
            WindowsPrincipal principal = new WindowsPrincipal(identity);
            return principal.IsInRole(WindowsBuiltInRole.Administrator);
        }

        public static void RunAdmin(string args)
        {
            try
            {
                var exeName = Process.GetCurrentProcess().MainModule.FileName;
                ProcessStartInfo startInfo = new ProcessStartInfo(exeName);
                startInfo.UseShellExecute = true;
                startInfo.WorkingDirectory = Directory.GetCurrentDirectory();
                startInfo.Verb = "runas";
                startInfo.Arguments = $"{args}";
                Process.Start(startInfo);
                System.Windows.Application.Current.Shutdown();
            }
            finally
            {
                System.Windows.Application.Current.Shutdown();
            }
        }

        public static async Task<bool> CheckInternet()
        {
            Write2Log("Checking Internet");
            bool hasInternet = false;

            try
            {
                string datasurl = online_datas;
                HttpClient web = new HttpClient();
                HttpResponseMessage rep = await web.GetAsync(datasurl);
                if (rep.StatusCode == HttpStatusCode.OK)
                {
                    string jsonContent = await web.GetStringAsync(datasurl);
                    dynamic jsonObject = JsonConvert.DeserializeObject(jsonContent);
                    if (jsonObject.urls != null && jsonObject.urls["const"] != null)
                    {
                        string url = jsonObject.urls["const"].ToString();
                        if (url == "noop")
                        {
                            Write2Log("Internet OK");
                            hasInternet = true;
                        }
                    }
                }
            }
            catch (Exception e)
            {
                Write2Log("No Internet: " + e.Message);
                hasInternet = false;
            }

            return hasInternet;

            /*
            int Out;
            if (InternetGetConnectedState(out Out, 0) == true) return true;
            else return false;
            */
        }

        public static async Task PrepareResources()
        {
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;

            if (await UT.CheckInternet())
            {
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\Edge\\edgesetup.exe"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (Edge)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("edgesetup"), UT.utpath + "\\Unowhy Tools\\Temps\\Edge\\edgesetup.exe", progress, cancellationToken.Token);
                }
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\ChangeLogo\\ChangeLogoWin64.exe"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (Change Logo)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("changelogo"), UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\ChangeLogo\\ChangeLogoWin64.exe", progress, cancellationToken.Token);
                }
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\HackBGRT\\setup.exe"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (HackBGRT)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("hackbgrt"), UT.utpath + "\\Unowhy Tools\\Temps\\HackBGRT.zip", progress, cancellationToken.Token);
                    await MainWindow.USSwB("Extracting... (HackBGRT)");
                    await Task.Delay(100);
                    await Task.Run(() =>
                    {
                        ZipFile.ExtractToDirectory(UT.utpath + "\\Unowhy Tools\\Temps\\HackBGRT.zip", UT.utpath + "\\Unowhy Tools\\Temps\\HackBGRT", true);
                    });
                }
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AFU\\" + "amigendrv64.sys") || !File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AFU\\" + "AFUWINx64.exe"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (AFUWin)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("afuwin"), UT.utpath + "\\Unowhy Tools\\Temps\\AFUWin.zip", progress, cancellationToken.Token);
                    await MainWindow.USSwB("Extracting... (AFUWin)");
                    await Task.Delay(100);
                    await Task.Run(() =>
                    {
                        ZipFile.ExtractToDirectory(UT.utpath + "\\Unowhy Tools\\Temps\\AFUWin.zip", UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AFU", true);
                    });
                }
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AMIDE\\" + "AMIDEWINx64.exe") || !File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AMIDE\\" + "AMIFLDRV64.sys"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (AMIDEWin)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("amidewin"), UT.utpath + "\\Unowhy Tools\\Temps\\AMIDEWin.zip", progress, cancellationToken.Token);
                    await MainWindow.USSwB("Extracting... (AMIDEWin)");
                    await Task.Delay(100);
                    await Task.Run(() =>
                    {
                        ZipFile.ExtractToDirectory(UT.utpath + "\\Unowhy Tools\\Temps\\AMIDEWin.zip", UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\AMIDE", true);
                    });
                }
                if (!File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\IFPT\\FPTW_Jasper.exe") || !File.Exists(UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\IFPT\\FPTW_Tiger.exe"))
                {
                    var progress = new System.Progress<double>();
                    var cancellationToken = new CancellationTokenSource();
                    string dl = "Downloading... (IFPT)";
                    await MainWindow.USSwB(dl);
                    progress.ProgressChanged += async (sender, value) =>
                    {
                        mainWindow.SplashText.Text = dl + " (" + value.ToString("###") + "%)";
                    };
                    await UT.DlFilewithProgress(await UT.OnlineDatas.GetUrls("fptw2"), UT.utpath + "\\Unowhy Tools\\Temps\\IFPT.zip", progress, cancellationToken.Token);
                    await MainWindow.USSwB("Extracting... (IFPT)");
                    await Task.Delay(100);
                    await Task.Run(() =>
                    {
                        ZipFile.ExtractToDirectory(UT.utpath + "\\Unowhy Tools\\Temps\\IFPT.zip", UT.utpath + "\\Unowhy Tools\\Temps\\AMI\\IFPT", true);
                    });
                }
            }
        }

        public static async Task OneTimeCheck()
        {
            await MainWindow.USS("Checking... (Getting Hardware Info)");
            Write2Log("Getting PC Infos");

            await MainWindow.USS("Hardware Info... (Name)");

            await MainWindow.USS("Hardware Info... (Name)");
            string hn = await RunReturn("hostname", "");
            UTdata.HostName = hn.Replace("\n", "").Replace("\r", "").Replace(" ", "");

            await MainWindow.USS("Hardware Info... (Manufacturer)");
            UTdata.mf = GetWMI("Win32_ComputerSystem", "Manufacturer");

            await MainWindow.USS("Hardware Info... (Model)");
            UTdata.md = GetWMI("Win32_ComputerSystem", "Model");

            await MainWindow.USS("Hardware Info... (SKU)");
            UTdata.sku = GetWMI("Win32_ComputerSystem", "SystemSKUNumber");

            await MainWindow.USS("Hardware Info... (Motherboard Manufacturer)");
            UTdata.mbmf = GetWMI("Win32_BaseBoard", "Manufacturer");

            await MainWindow.USS("Hardware Info... (Motherboard Model)");
            UTdata.mbmd = GetWMI("Win32_BaseBoard", "Product");

            await MainWindow.USS("Hardware Info... (Motherboard Version)");
            UTdata.mbv = GetWMI("Win32_BaseBoard", "Version");

            await MainWindow.USS("Hardware Info... (OS)");
            UTdata.os = GetWMI("Win32_OperatingSystem", "Caption");

            await MainWindow.USS("Hardware Info... (BIOS Manufacturer)");
            UTdata.biosmf = GetWMI("Win32_BIOS", "Manufacturer");

            await MainWindow.USS("Hardware Info... (BIOS Variant)");
            UTdata.bios = GetWMI("Win32_BIOS", "SMBIOSBIOSVersion");

            await MainWindow.USS("Hardware Info... (BIOS Version)");
            UTdata.biosv = GetWMI("Win32_BIOS", "SMBIOSBIOSVersion");

            await MainWindow.USS("Hardware Info... (BIOS Date)");
            string biosd = GetWMI("Win32_BIOS", "ReleaseDate");
            UTdata.biosd = DateTime.ParseExact(biosd.Substring(0, 14), "yyyyMMddHHmmss", null).ToString("MM/dd/yyyy");

            await MainWindow.USS("Hardware Info... (Serial Number)");
            UTdata.sn = GetWMI("Win32_BIOS", "SerialNumber");

            await MainWindow.USS("Hardware Info... (Family)");
            UTdata.family = GetWMI("Win32_ComputerSystem", "SystemFamily");

            await MainWindow.USS("Hardware Info... (CPU)");
            UTdata.cpu = GetWMI("Win32_Processor", "Name");

            await MainWindow.USS("Hardware Info... (RAM)");
            UTdata.ram = GetWMI("Win32_ComputerSystem", "TotalPhysicalMemory");

            await MainWindow.USS("Hardware Info... (Done)");

            string HostName = UTdata.HostName;

            if (UTdata.HostName.Length > 15)
            {
                HostName = UTdata.HostName.Substring(0, 15);
            }

            if (UTdata.UserID.Contains(HostName.ToLower()))
            {
                UTdata.User = UTdata.UserID.Replace(UTdata.HostName.ToLower() + "\\", "");
            }
            else if (UTdata.UserID.Contains("azuread"))
            {
                UTdata.User = UTdata.UserID;
                UTdata.AADUser = true;
            }

            Write2Log(UTdata.HostName);
            Write2Log(UTdata.User);
            Write2Log(UTdata.UserID);
            Write2Log(UTdata.mf);
            Write2Log(UTdata.md);
            Write2Log(UTdata.sku);
            Write2Log(UTdata.mbmf);
            Write2Log(UTdata.mbmd);
            Write2Log(UTdata.mbv);
            Write2Log(UTdata.os);
            Write2Log(UTdata.biosmf);
            Write2Log(UTdata.bios);
            Write2Log(UTdata.biosv);
            Write2Log(UTdata.biosd);
            Write2Log(UTdata.sn);
            Write2Log(UTdata.cpu);
            Write2Log(UTdata.ram);

            Write2Log("Done");

            await MainWindow.USS("Checking... (Getting Software Info)");

            await MainWindow.USS("Software Info... (Users and Groups lang)");
            Write2Log("Checking if is Administrator or Adminitrateur");

            string adminname = await RunReturn("net", "user");
            if (adminname.Contains("Administrateur"))
            {
                UTdata.AdminName = "Administrateur";
            }
            else if (adminname.Contains("Administrator"))
            {
                UTdata.AdminName = "Administrator";
            }

            Write2Log("=> " + UTdata.AdminName);

            Write2Log("Checking if is Administrators or Adminitrateurs");

            string adminsname = await RunReturn("net", "localgroup");
            if (adminsname.Contains("Administrateurs"))
            {
                UTdata.AdminsName = "Administrateurs";
            }
            else if (adminsname.Contains("Administrators"))
            {
                UTdata.AdminsName = "Administrators";
            }

            Write2Log("=> " + UTdata.AdminsName);
        }

        public static bool allrun = false;
        public static async Task Check(string step)
        {
            Write2Log("====== Dynamic Buttons ======");
            Write2Log("Step: " + step);

            if (step.Contains("all"))
            {
                await MainWindow.USS("Software Info... (HSQM)");

                #region Hisqool Manager

                Write2Log("=== HSM service ===");
                bool hsme = await UT.serv.exist("HiSqoolManager");
                if (hsme)
                {
                    ServiceController sc = new ServiceController();
                    sc.ServiceName = "HiSqoolManager";

                    if (sc.StartType == ServiceStartMode.Automatic)
                    {
                        if (sc.Status == ServiceControllerStatus.Running)
                        {
                            UTdata.HSMRunning = true;
                            UTdata.HSMEnabled = true;
                            UTdata.HSMExist = true;
                            UTdata.HSMExeExist = true;
                            Write2Log("HSM is running");
                        }
                        else
                        {
                            UTdata.HSMRunning = false;
                            UTdata.HSMEnabled = true;
                            UTdata.HSMExist = true;
                            UTdata.HSMExeExist = true;
                            Write2Log("HSM is stopped");
                        }
                    }
                    else
                    {
                        UTdata.HSMRunning = false;
                        UTdata.HSMEnabled = false;
                        UTdata.HSMExist = true;
                        UTdata.HSMExeExist = true;
                        Write2Log("HSM is disabled");
                    }
                    if (!File.Exists("C:\\Program Files\\Unowhy\\HiSqool Manager\\HiSqoolManager.exe"))
                    {
                        UTdata.HSMRunning = true;
                        UTdata.HSMEnabled = true;
                        UTdata.HSMExist = true;
                        UTdata.HSMExeExist = false;
                        Write2Log("HSM is deleted");
                    }
                }
                else
                {
                    UTdata.HSMRunning = false;
                    UTdata.HSMEnabled = false;
                    UTdata.HSMExist = false;
                    UTdata.HSMExeExist = false;
                    Write2Log("HSM services is not present");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Azure)");

                #region Azure

                string preazure = await RunReturn("powershell", "start-process -FilePath \"dsregcmd\" -ArgumentList \"/status\" -nonewwindow");
                string azure = GetLine(preazure, 6);

                Write2Log("=== Azure AD ===");
                if (azure.Contains("NO"))
                {
                    UTdata.AAD = false;
                    Write2Log("Azure AD joined: NO");
                }
                else
                {
                    UTdata.AAD = true;
                    Write2Log("Azure AD joined: YES");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Admins)");

                #region Admins

                string preadmins = await RunReturn("net", $"localgroup {UTdata.AdminsName}");
                string admins = preadmins.ToLower();

                Write2Log("=== Admins ===");
                if (admins.Contains(UTdata.User))
                {
                    UTdata.Admin = true;
                    Write2Log("User is admin");
                }
                else
                {
                    UTdata.Admin = false;
                    Write2Log("User is not admin");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Folders)");

                #region Folders

                Write2Log("=== Folders ===");
                if (Directory.Exists("C:\\ProgramData\\RIDF") == false)
                {
                    UTdata.RIDFFolderExist = false;
                    Write2Log("RIDF: False");
                }
                else
                {
                    UTdata.RIDFFolderExist = true;
                    Write2Log("RIDF: True");
                }
                if (Directory.Exists("C:\\ProgramData\\ENT") == false)
                {
                    UTdata.ENTFolderExist = false;
                    Write2Log("ENT: False");
                }
                else
                {
                    UTdata.ENTFolderExist = true;
                    Write2Log("ENT: True");
                }
                if (Directory.Exists("C:\\Windows\\system32\\OEM") == false)
                {
                    UTdata.OEMFolderExist = false;
                    Write2Log("OEM: False");
                }
                else
                {
                    UTdata.OEMFolderExist = true;
                    Write2Log("OEM: True");
                }
                if (Directory.Exists("C:\\Program Files\\Unowhy\\TO_INSTALL") == false)
                {
                    UTdata.TIFolderExist = false;
                    Write2Log("TO_INSTALL: False");
                }
                else
                {
                    UTdata.TIFolderExist = true;
                    Write2Log("TO_INSTALL: True");
                }
                if (Directory.Exists("C:\\Program Files\\Unowhy\\HiSqool Manager") == false)
                {
                    UTdata.HSQMFolderExist = false;
                    Write2Log("Hisqool Manager: False");
                }
                else
                {
                    UTdata.HSQMFolderExist = true;
                    Write2Log("Hisqool Manager: True");
                }
                if (File.Exists("C:\\Program Files\\Unowhy\\HiSqool\\HiSqool.exe") == false)
                {
                    UTdata.HSQFolderExist = false;
                    Write2Log("Hisqool: False");
                }
                else
                {
                    UTdata.HSQFolderExist = true;
                    Write2Log("Hisqool: True");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (ENT User)");

                #region ENT user

                string users = await RunReturn("net", "user");

                Write2Log("=== ./ENT ===");
                if (users.Contains("ENT"))
                {
                    UTdata.ENTUser = true;
                    Write2Log("ENT User is present");
                }
                else
                {
                    UTdata.ENTUser = false;
                    Write2Log("ENT User is not present");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (WHE)");

                #region Windows Hello Enterprise

                Write2Log("=== Win Hello Ent ===");
                Write2Log("Open Key");
                RegistryKey whe1 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\PassportForWork");
                //RegistryKey whe2 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WinBio\\Credential Provider");
                RegistryKey whe3 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\PassportForWork\\DynamicLock");
                Write2Log("Open Key End");
                if (whe1 == null || /*whe2 == null ||*/ whe3 == null)
                {
                    UTdata.WHE = false;
                    Write2Log("WHE No Key");
                }
                else
                {
                    Write2Log("Open Val");
                    var val5 = whe3.GetValue("DynamicLock");
                    //string val2 = whe2.GetValue("Domain Accounts");
                    var val1 = whe1.GetValue("Enabled");
                    var val3 = whe1.GetValue("RequireSecurityDevice");
                    //string val4 = whe1.GetValue("UseCertificateForOnPremAuth").ToString();
                    Write2Log("Open Val End");

                    if (val1 == null || val3 == null || val5 == null)
                    {
                        UTdata.WHE = false;
                        Write2Log("WHE No Value");
                    }
                    else
                    {
                        string val21 = val1.ToString();
                        string val23 = val3.ToString();
                        string val25 = val5.ToString();
                        Write2Log("Read Val");
                        if (val21.Contains("1") && /*val2.Contains("1") &&*/ val23.Contains("1") && /*val4.Contains("1") &&*/ val25.Contains("1"))
                        {
                            UTdata.WHE = true;
                            Write2Log("WHE OK");
                        }
                        else
                        {
                            UTdata.WHE = false;
                            Write2Log("WHE Not OK");
                        }
                        Write2Log("Read Val End");
                    }
                }
                if (whe1 != null)
                {
                    whe1.Close();
                }
                /*if (whe2 != null)
                {
                    whe2.Close();
                }*/
                if (whe3 != null)
                {
                    whe3.Close();
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (TI Start)");

                #region TI Start

                Write2Log("=== Auto script of TI ===");
                DirectoryInfo dir = new DirectoryInfo("C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup");
                if (dir.Exists)
                {
                    FileInfo[] files = dir.GetFiles("silent_" + "*.*");
                    if (files.Length > 0)
                    {
                        UTdata.TIStartup = true;
                        Write2Log("Present");
                    }
                    else
                    {
                        UTdata.TIStartup = false;
                        Write2Log("Not present");
                    }
                }
                else
                {
                    UTdata.TIStartup = false;
                    Write2Log("Common startup not present");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (BootIM)");

                #region BootIM

                Write2Log("=== BootIM ===");
                RegistryKey bim1 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\bootim.exe");
                if (bim1 == null)
                {
                    UTdata.BIM = true;
                    Write2Log("OK");
                }
                else
                {
                    UTdata.BIM = false;
                    Write2Log("Redirected");
                }
                if (bim1 != null)
                {
                    bim1.Close();
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (BCDedit)");

                #region BCDedit

                string bcd = await RunReturn("bcdedit", "");

                Write2Log("=== BCD ===");
                if (bcd.Contains("IgnoreAllFailures"))
                {
                    UTdata.BCD = false;
                    Write2Log("BCD patched");
                }
                else
                {
                    UTdata.BCD = true;
                    Write2Log("BCD normal");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Shell)");

                #region Shell

                Write2Log("=== Shell ===");
                RegistryKey shellkey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon");
                string shellval = shellkey.GetValue("Shell").ToString();
                if (shellval == "explorer.exe")
                {
                    UTdata.ShellOK = true;
                }
                else
                {
                    UTdata.ShellOK = false;
                }
                Write2Log($"Shell: {shellval}");
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (TaskMGR)");

                #region TaskMGR

                Write2Log("=== TaskMGR ===");
                RegistryKey tmgr = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                if (tmgr != null)
                {
                    object t = tmgr.GetValue("DisableTaskMGR", null);
                    if (t == null)
                    {
                        UTdata.TaskMGR = true;
                        Write2Log("TaskMGR is enabled");
                    }
                    else
                    {
                        UTdata.TaskMGR = false;
                        Write2Log("TaskMGR is disabled");
                    }
                }
                else
                {
                    UTdata.TaskMGR = true;
                    Write2Log("TaskMGR is enabled");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Lockout)");

                #region Account Lockout

                Write2Log("=== Account Lockout ===");
                RegistryKey la = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                if (la != null)
                {
                    object l = la.GetValue("DisableLockWorkstation", null);
                    if (l == null)
                    {
                        UTdata.LockA = true;
                        Write2Log("Account Lockout is enabled");
                    }
                    else
                    {
                        UTdata.LockA = false;
                        Write2Log("Account Lockout is disabled");
                    }
                }
                else
                {
                    UTdata.LockA = true;
                    Write2Log("Account Lockout is enabled");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (CPO)");

                #region Camera Privacy Overlay

                Write2Log("=== Camera Privacy Overlay ===");
                RegistryKey co = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\OEM\\Device\\Capture");
                if (co != null)
                {
                    object c = co.GetValue("NoPhysicalCameraLED", null);
                    if (c == null)
                    {
                        UTdata.CamOver = false;
                        Write2Log("Camera Privacy Overlay No val");
                    }
                    else
                    {
                        int lc2 = (int)co.GetValue("NoPhysicalCameraLED", 0);
                        if (lc2 == 1)
                        {
                            UTdata.CamOver = true;
                            Write2Log("Camera Privacy Overlay OK");
                        }
                        else
                        {
                            UTdata.CamOver = false;
                            Write2Log("Camera Privacy Overlay is 0");
                        }
                    }
                }
                else
                {
                    UTdata.CamOver = false;
                    Write2Log("Camera Privacy Overlay No key");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Verbose)");

                #region Windows verbose status

                Write2Log("=== Windows verbose status ===");
                RegistryKey vo = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                if (vo != null)
                {
                    object v = vo.GetValue("VerboseStatus", null);
                    if (v == null)
                    {
                        UTdata.VerbStat = false;
                        Write2Log("Windows verbose status No val");
                    }
                    else
                    {
                        int lv2 = (int)vo.GetValue("VerboseStatus", 0);
                        if (lv2 == 1)
                        {
                            UTdata.VerbStat = true;
                            Write2Log("Windows verbose status OK");
                        }
                        else
                        {
                            UTdata.VerbStat = false;
                            Write2Log("Windows verbose status is 0");
                        }
                    }
                }
                else
                {
                    UTdata.VerbStat = false;
                    Write2Log("Windows verbose status No key");
                }
                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (WinRE)");

                #region WinRE

                Write2Log("=== WinRE ===");

                string winre = await RunReturn("reagentc", "/info");
                if (winre.Contains("Enabled"))
                {
                    UTdata.WinRE = true;
                    Write2Log("WinRE is enabled");
                }
                else
                {
                    UTdata.WinRE = false;
                    Write2Log("WinRE is disabled");
                }

                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (Edge)");

                #region Edge

                Write2Log("=== Edge ===");

                if (File.Exists("C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe"))
                {
                    UTdata.EdgeInstalled = true;
                    Write2Log("Edge is present");
                }
                else
                {
                    UTdata.EdgeInstalled = false;
                    Write2Log("Edge is not present");
                }

                RegistryKey eu = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Microsoft\EdgeUpdate");
                if (eu != null)
                {
                    object dnu = eu.GetValue("DoNotUpdateToEdgeWithChromium", null);
                    if (dnu != null)
                    {
                        int dnu2 = (int)eu.GetValue("DoNotUpdateToEdgeWithChromium", 0);
                        if (dnu2 == 1)
                        {
                            UTdata.NoEdgeReg = true;
                        }
                        else
                        {
                            UTdata.NoEdgeReg = false;
                        }
                    }
                    else
                    {
                        UTdata.NoEdgeReg = false;
                    }
                }
                else
                {
                    UTdata.NoEdgeReg = false;
                }

                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (WinDef)");

                #region Windows Defender

                Write2Log("=== Windows Defender ===");

                RegistryKey wd = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Policies\Microsoft\Windows Defender");
                RegistryKey rtp = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection");
                if (wd != null && rtp != null)
                {
                    object das = wd.GetValue("DisableAntiSpyware", null);
                    object drm = rtp.GetValue("DisableRealtimeMonitoring", null);
                    if (das != null && drm != null)
                    {
                        int das2 = (int)wd.GetValue("DisableAntiSpyware", 0);
                        int drm2 = (int)rtp.GetValue("DisableRealtimeMonitoring", 0);
                        if (das2 == 1 && drm2 == 1 && (await UT.UTS.UTSmsg("UTSWD", "GetWDS")).Contains("True"))
                        {
                            UTdata.WinDefEnabled = false;
                            UT.Write2Log("WinDef Disabled");
                        }
                        else
                        {
                            UTdata.WinDefEnabled = true;
                            UT.Write2Log("WinDef Enabled (Not 1)");
                        }
                    }
                    else
                    {
                        UTdata.WinDefEnabled = true;
                        UT.Write2Log("WinDef Enabled (Not Value)");
                    }
                }
                else
                {
                    UTdata.WinDefEnabled = true;
                    UT.Write2Log("WinDef Enabled (Not Key)");
                }

                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                await MainWindow.USS("Software Info... (RIDF Certificate)");

                #region RIDF Certificate

                Write2Log("=== RIDF Certificate ===");

                string rootcert = await UT.RunReturn("cmd", "/c \"certutil -store Root | findstr /C:RIDF\"");
                if (rootcert.Contains("RIDF"))
                {
                    UTdata.RIDFCertInstalled = true;
                    Write2Log("RIDF Certificate is present");
                }
                else
                {
                    UTdata.RIDFCertInstalled = false;
                    Write2Log("RIDF Certificate is not present");
                }

                Write2Log("=== End ===" + Environment.NewLine);

                #endregion

                allrun = true;
            }
            else
            {
                if (step.Contains("hsqm"))
                {
                    #region Hisqool Manager

                    Write2Log("=== HSM service ===");
                    bool hsme = await UT.serv.exist("HiSqoolManager");
                    if (hsme)
                    {
                        ServiceController sc = new ServiceController();
                        sc.ServiceName = "HiSqoolManager";

                        if (sc.StartType == ServiceStartMode.Automatic)
                        {
                            if (sc.Status == ServiceControllerStatus.Running)
                            {
                                UTdata.HSMRunning = true;
                                UTdata.HSMEnabled = true;
                                UTdata.HSMExist = true;
                                UTdata.HSMExeExist = true;
                                Write2Log("HSM is running");
                            }
                            else
                            {
                                UTdata.HSMRunning = false;
                                UTdata.HSMEnabled = true;
                                UTdata.HSMExist = true;
                                UTdata.HSMExeExist = true;
                                Write2Log("HSM is stopped");
                            }
                        }
                        else
                        {
                            UTdata.HSMRunning = false;
                            UTdata.HSMEnabled = false;
                            UTdata.HSMExist = true;
                            UTdata.HSMExeExist = true;
                            Write2Log("HSM is disabled");
                        }
                        if (!File.Exists("C:\\Program Files\\Unowhy\\HiSqool Manager\\HiSqoolManager.exe"))
                        {
                            UTdata.HSMRunning = true;
                            UTdata.HSMEnabled = true;
                            UTdata.HSMExist = true;
                            UTdata.HSMExeExist = false;
                            Write2Log("HSM is deleted");
                        }
                    }
                    else
                    {
                        UTdata.HSMRunning = false;
                        UTdata.HSMEnabled = false;
                        UTdata.HSMExist = false;
                        UTdata.HSMExeExist = false;
                        Write2Log("HSM services is not present");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("azure"))
                {
                    #region Azure

                    string preazure = await RunReturn("powershell", "start-process -FilePath \"dsregcmd\" -ArgumentList \"/status\" -nonewwindow");
                    string azure = GetLine(preazure, 6);

                    Write2Log("=== Azure AD ===");
                    if (azure.Contains("NO"))
                    {
                        UTdata.AAD = false;
                        Write2Log("Azure AD joined: NO");
                    }
                    else
                    {
                        UTdata.AAD = true;
                        Write2Log("Azure AD joined: YES");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("admins"))
                {
                    #region Admins

                    string preadmins = await RunReturn("net", $"localgroup {UTdata.AdminsName}");
                    string admins = preadmins.ToLower();

                    Write2Log("=== Admins ===");
                    if (admins.Contains(UTdata.User))
                    {
                        UTdata.Admin = true;
                        Write2Log("User is admin");
                    }
                    else
                    {
                        UTdata.Admin = false;
                        Write2Log("User is not admin");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("folders"))
                {
                    #region Folders

                    Write2Log("=== Folders ===");
                    if (Directory.Exists("C:\\ProgramData\\RIDF") == false)
                    {
                        UTdata.RIDFFolderExist = false;
                        Write2Log("RIDF: False");
                    }
                    else
                    {
                        UTdata.RIDFFolderExist = true;
                        Write2Log("RIDF: True");
                    }
                    if (Directory.Exists("C:\\ProgramData\\ENT") == false)
                    {
                        UTdata.ENTFolderExist = false;
                        Write2Log("ENT: False");
                    }
                    else
                    {
                        UTdata.ENTFolderExist = true;
                        Write2Log("ENT: True");
                    }
                    if (Directory.Exists("C:\\Windows\\system32\\OEM") == false)
                    {
                        UTdata.OEMFolderExist = false;
                        Write2Log("OEM: False");
                    }
                    else
                    {
                        UTdata.OEMFolderExist = true;
                        Write2Log("OEM: True");
                    }
                    if (Directory.Exists("C:\\Program Files\\Unowhy\\TO_INSTALL") == false)
                    {
                        UTdata.TIFolderExist = false;
                        Write2Log("TO_INSTALL: False");
                    }
                    else
                    {
                        UTdata.TIFolderExist = true;
                        Write2Log("TO_INSTALL: True");
                    }
                    if (Directory.Exists("C:\\Program Files\\Unowhy\\HiSqool Manager") == false)
                    {
                        UTdata.HSQMFolderExist = false;
                        Write2Log("Hisqool Manager: False");
                    }
                    else
                    {
                        UTdata.HSQMFolderExist = true;
                        Write2Log("Hisqool Manager: True");
                    }
                    if (File.Exists("C:\\Program Files\\Unowhy\\HiSqool\\HiSqool.exe") == false)
                    {
                        UTdata.HSQFolderExist = false;
                        Write2Log("Hisqool: False");
                    }
                    else
                    {
                        UTdata.HSQFolderExist = true;
                        Write2Log("Hisqool: True");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("entuser"))
                {
                    #region ENT user

                    string users = await RunReturn("net", "user");

                    Write2Log("=== ./ENT ===");
                    if (users.Contains("ENT"))
                    {
                        UTdata.ENTUser = true;
                        Write2Log("ENT User is present");
                    }
                    else
                    {
                        UTdata.ENTUser = false;
                        Write2Log("ENT User is not present");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("whe"))
                {
                    #region Windows Hello Enterprise

                    Write2Log("=== Win Hello Ent ===");
                    Write2Log("Open Key");
                    RegistryKey whe1 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\PassportForWork");
                    //RegistryKey whe2 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WinBio\\Credential Provider");
                    RegistryKey whe3 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Policies\\Microsoft\\PassportForWork\\DynamicLock");
                    Write2Log("Open Key End");
                    if (whe1 == null || /*whe2 == null ||*/ whe3 == null)
                    {
                        UTdata.WHE = false;
                        Write2Log("WHE No Key");
                    }
                    else
                    {
                        Write2Log("Open Val");
                        var val5 = whe3.GetValue("DynamicLock");
                        //string val2 = whe2.GetValue("Domain Accounts");
                        var val1 = whe1.GetValue("Enabled");
                        var val3 = whe1.GetValue("RequireSecurityDevice");
                        //string val4 = whe1.GetValue("UseCertificateForOnPremAuth").ToString();
                        Write2Log("Open Val End");

                        if (val1 == null || val3 == null || val5 == null)
                        {
                            UTdata.WHE = false;
                            Write2Log("WHE No Value");
                        }
                        else
                        {
                            string val21 = val1.ToString();
                            string val23 = val3.ToString();
                            string val25 = val5.ToString();
                            Write2Log("Read Val");
                            if (val21.Contains("1") && /*val2.Contains("1") &&*/ val23.Contains("1") && /*val4.Contains("1") &&*/ val25.Contains("1"))
                            {
                                UTdata.WHE = true;
                                Write2Log("WHE OK");
                            }
                            else
                            {
                                UTdata.WHE = false;
                                Write2Log("WHE Not OK");
                            }
                            Write2Log("Read Val End");
                        }
                    }
                    if (whe1 != null)
                    {
                        whe1.Close();
                    }
                    /*if (whe2 != null)
                    {
                        whe2.Close();
                    }*/
                    if (whe3 != null)
                    {
                        whe3.Close();
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("tistart"))
                {
                    #region TI Start

                    Write2Log("=== Auto script of TI ===");
                    DirectoryInfo dir = new DirectoryInfo("C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup");
                    if (dir.Exists)
                    {
                        FileInfo[] files = dir.GetFiles("silent_" + "*.*");
                        if (files.Length > 0)
                        {
                            UTdata.TIStartup = true;
                            Write2Log("Present");
                        }
                        else
                        {
                            UTdata.TIStartup = false;
                            Write2Log("Not present");
                        }
                    }
                    else
                    {
                        UTdata.TIStartup = false;
                        Write2Log("Common startup not present");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("bootim"))
                {
                    #region BootIM

                    Write2Log("=== BootIM ===");
                    RegistryKey bim1 = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\bootim.exe");
                    if (bim1 == null)
                    {
                        UTdata.BIM = true;
                        Write2Log("OK");
                    }
                    else
                    {
                        UTdata.BIM = false;
                        Write2Log("Redirected");
                    }
                    if (bim1 != null)
                    {
                        bim1.Close();
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("bcdedit"))
                {
                    #region BCDedit

                    string bcd = await RunReturn("bcdedit", "");

                    Write2Log("=== BCD ===");
                    if (bcd.Contains("IgnoreAllFailures"))
                    {
                        UTdata.BCD = false;
                        Write2Log("BCD patched");
                    }
                    else
                    {
                        UTdata.BCD = true;
                        Write2Log("BCD normal");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("shell"))
                {
                    #region Shell

                    Write2Log("=== Shell ===");
                    RegistryKey shellkey = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon");
                    string shellval = shellkey.GetValue("Shell").ToString();
                    if (shellval == "explorer.exe")
                    {
                        UTdata.ShellOK = true;
                    }
                    else
                    {
                        UTdata.ShellOK = false;
                    }
                    Write2Log($"Shell: {shellval}");
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("taskmgr"))
                {
                    #region TaskMGR

                    Write2Log("=== TaskMGR ===");
                    RegistryKey tmgr = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                    if (tmgr != null)
                    {
                        object t = tmgr.GetValue("DisableTaskMGR", null);
                        if (t == null)
                        {
                            UTdata.TaskMGR = true;
                            Write2Log("TaskMGR is enabled");
                        }
                        else
                        {
                            UTdata.TaskMGR = false;
                            Write2Log("TaskMGR is disabled");
                        }
                    }
                    else
                    {
                        UTdata.TaskMGR = true;
                        Write2Log("TaskMGR is enabled");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("lockout"))
                {
                    #region Account Lockout

                    Write2Log("=== Account Lockout ===");
                    RegistryKey la = Registry.CurrentUser.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                    if (la != null)
                    {
                        object l = la.GetValue("DisableLockWorkstation", null);
                        if (l == null)
                        {
                            UTdata.LockA = true;
                            Write2Log("Account Lockout is enabled");
                        }
                        else
                        {
                            UTdata.LockA = false;
                            Write2Log("Account Lockout is disabled");
                        }
                    }
                    else
                    {
                        UTdata.LockA = true;
                        Write2Log("Account Lockout is enabled");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("cpo"))
                {
                    #region Camera Privacy Overlay

                    Write2Log("=== Camera Privacy Overlay ===");
                    RegistryKey co = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\OEM\\Device\\Capture");
                    if (co != null)
                    {
                        object c = co.GetValue("NoPhysicalCameraLED", null);
                        if (c == null)
                        {
                            UTdata.CamOver = false;
                            Write2Log("Camera Privacy Overlay No val");
                        }
                        else
                        {
                            int lc2 = (int)co.GetValue("NoPhysicalCameraLED", 0);
                            if (lc2 == 1)
                            {
                                UTdata.CamOver = true;
                                Write2Log("Camera Privacy Overlay OK");
                            }
                            else
                            {
                                UTdata.CamOver = false;
                                Write2Log("Camera Privacy Overlay is 0");
                            }
                        }
                    }
                    else
                    {
                        UTdata.CamOver = false;
                        Write2Log("Camera Privacy Overlay No key");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("verbose"))
                {
                    #region Windows verbose status

                    Write2Log("=== Windows verbose status ===");
                    RegistryKey vo = Registry.LocalMachine.OpenSubKey("SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System");
                    if (vo != null)
                    {
                        object v = vo.GetValue("VerboseStatus", null);
                        if (v == null)
                        {
                            UTdata.VerbStat = false;
                            Write2Log("Windows verbose status No val");
                        }
                        else
                        {
                            int lv2 = (int)vo.GetValue("VerboseStatus", 0);
                            if (lv2 == 1)
                            {
                                UTdata.VerbStat = true;
                                Write2Log("Windows verbose status OK");
                            }
                            else
                            {
                                UTdata.VerbStat = false;
                                Write2Log("Windows verbose status is 0");
                            }
                        }
                    }
                    else
                    {
                        UTdata.VerbStat = false;
                        Write2Log("Windows verbose status No key");
                    }
                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("winre"))
                {
                    #region WinRE

                    Write2Log("=== WinRE ===");

                    string winre = await RunReturn("reagentc", "/info");
                    if (winre.Contains("Enabled"))
                    {
                        UTdata.WinRE = true;
                        Write2Log("WinRE is enabled");
                    }
                    else
                    {
                        UTdata.WinRE = false;
                        Write2Log("WinRE is disabled");
                    }

                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("edge"))
                {
                    #region Edge

                    Write2Log("=== Edge ===");

                    if (File.Exists("C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe"))
                    {
                        UTdata.EdgeInstalled = true;
                        Write2Log("Edge is present");
                    }
                    else
                    {
                        UTdata.EdgeInstalled = false;
                        Write2Log("Edge is not present");
                    }

                    RegistryKey eu = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Microsoft\EdgeUpdate");
                    if (eu != null)
                    {
                        object dnu = eu.GetValue("DoNotUpdateToEdgeWithChromium", null);
                        if (dnu != null)
                        {
                            int dnu2 = (int)eu.GetValue("DoNotUpdateToEdgeWithChromium", 0);
                            if (dnu2 == 1)
                            {
                                UTdata.NoEdgeReg = true;
                            }
                            else
                            {
                                UTdata.NoEdgeReg = false;
                            }
                        }
                        else
                        {
                            UTdata.NoEdgeReg = false;
                        }
                    }
                    else
                    {
                        UTdata.NoEdgeReg = false;
                    }

                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("windef"))
                {
                    #region Windows Defender

                    Write2Log("=== Windows Defender ===");

                    RegistryKey wd = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Policies\Microsoft\Windows Defender");
                    RegistryKey rtp = Registry.LocalMachine.OpenSubKey(@"SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection");
                    if (wd != null && rtp != null)
                    {
                        object das = wd.GetValue("DisableAntiSpyware", null);
                        object drm = rtp.GetValue("DisableRealtimeMonitoring", null);
                        if (das != null && drm != null)
                        {
                            int das2 = (int)wd.GetValue("DisableAntiSpyware", 0);
                            int drm2 = (int)rtp.GetValue("DisableRealtimeMonitoring", 0);
                            if (das2 == 1 && drm2 == 1 && (await UT.UTS.UTSmsg("UTSWD", "GetWDS")).Contains("True"))
                            {
                                UTdata.WinDefEnabled = false;
                                UT.Write2Log("WinDef Disabled");
                            }
                            else
                            {
                                UTdata.WinDefEnabled = true;
                                UT.Write2Log("WinDef Enabled (Not 1)");
                            }
                        }
                        else
                        {
                            UTdata.WinDefEnabled = true;
                            UT.Write2Log("WinDef Enabled (Not Value)");
                        }
                    }
                    else
                    {
                        UTdata.WinDefEnabled = true;
                        UT.Write2Log("WinDef Enabled (Not Key)");
                    }

                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }

                if (step.Contains("ridfcert"))
                {
                    #region RIDF Certificate

                    Write2Log("=== RIDF Certificate ===");

                    string rootcert = await UT.RunReturn("cmd", "/wait /c \"certutil -store Root | findstr /C:RIDF\"");
                    if (rootcert.Contains("RIDF"))
                    {
                        UTdata.RIDFCertInstalled = true;
                        Write2Log("RIDF Certificate is present");
                    }
                    else
                    {
                        UTdata.RIDFCertInstalled = false;
                        Write2Log("RIDF Certificate is not present");
                    }

                    Write2Log("=== End ===" + Environment.NewLine);

                    #endregion
                }
            }

            Write2Log("====== End ======");

            if (allrun)
            {
                await SendCheck();
            }
        }

        public static string GetWMI(string classname, string propertyname)
        {
            Write2Log("Get WMI: " + classname + " | " + propertyname);

            try
            {
                ManagementObjectSearcher searcher = new ManagementObjectSearcher($"SELECT {propertyname} FROM {classname}");
                ManagementObjectCollection result = searcher.Get();
                foreach (ManagementObject obj in result)
                {
                    Write2Log("Get WMI done: " + obj[propertyname]?.ToString());
                    return obj[propertyname]?.ToString();
                }
                Write2Log("Get WMI fail");
                return "null";
            }
            catch
            {
                Write2Log("Get WMI fail");
                return "null";
            }
        }

        public static async Task DlFilewithProgress(string url, string path, IProgress<double> progress, CancellationToken token)
        {
            Write2Log("Downloading file: From \"" + url + "\" to \"" + path + "\"");
            var client = new HttpClient();
            var response = await client.GetAsync(url, HttpCompletionOption.ResponseHeadersRead, token);

            if (!response.IsSuccessStatusCode)
            {
                throw new Exception(string.Format("Download failed: {0}", response.StatusCode));
            }

            var total = response.Content.Headers.ContentLength.HasValue ? response.Content.Headers.ContentLength.Value : -1L;
            var canReportProgress = total != -1 && progress != null;

            using (var stream = await response.Content.ReadAsStreamAsync())
            using (var fileStream = new FileStream(path, FileMode.Create, FileAccess.Write))
            {
                var totalRead = 0L;
                var buffer = new byte[4096];
                var isMoreToRead = true;

                do
                {
                    token.ThrowIfCancellationRequested();

                    var read = await stream.ReadAsync(buffer, 0, buffer.Length, token);

                    if (read == 0)
                    {
                        isMoreToRead = false;
                    }
                    else
                    {
                        await fileStream.WriteAsync(buffer, 0, read);

                        totalRead += read;

                        if (canReportProgress)
                        {
                            progress.Report((totalRead * 1d) / (total * 1d) * 100);
                        }
                    }
                } while (isMoreToRead);
            }

            Write2Log("Download completed");
        }

        public static async Task Extract(string file, string outPath)
        {
            string packUri = "pack://application:,,,/Resources/" + file;
            var uri = new Uri(packUri);
            var partUri = PackUriHelper.GetPartUri(uri);
            var streamInfo = System.Windows.Application.GetResourceStream(uri);

            using (var inputStream = streamInfo.Stream)
            using (var outputStream = File.Create(outPath))
            {
                await inputStream.CopyToAsync(outputStream);
            }
        }

        public static BitmapImage GetImgSource(string resname)
        {
            BitmapImage bmp = new BitmapImage(new System.Uri("pack://application:,,,/Resources/" + resname));
            return bmp;
        }

        public static ImageSource GetImageSourceFromExe(string path)
        {
            try
            {
                Icon appIcon = Icon.ExtractAssociatedIcon(path);

                if (appIcon != null)
                {
                    ImageSource imageSource = Imaging.CreateBitmapSourceFromHIcon(
                        appIcon.Handle,
                        Int32Rect.Empty,
                        BitmapSizeOptions.FromEmptyOptions());

                    return imageSource;
                }
            }
            catch
            {

            }

            return null;
        }

        public static ImageSource GetImageSourceFromIco(string path)
        {
            try
            {
                Icon icon = new Icon(path);

                ImageSource imageSource = Imaging.CreateBitmapSourceFromHIcon(
                    icon.Handle,
                    Int32Rect.Empty,
                    BitmapSizeOptions.FromEmptyOptions());

                return imageSource;
            }
            catch
            {

            }

            return null;
        }

        public static Icon GetIconFromRes(string resname)
        {
            var imgsource = UT.GetImgSource(resname);

            Bitmap bitmap = null;
            var encoder = new PngBitmapEncoder();
            encoder.Frames.Add(BitmapFrame.Create(imgsource));
            using (MemoryStream ms = new MemoryStream())
            {
                encoder.Save(ms);
                ms.Seek(0, SeekOrigin.Begin);
                bitmap = new Bitmap(ms);
            }

            Icon icon = Icon.FromHandle(bitmap.GetHicon());
            return icon;
        }

        public static bool DialogQShow(string msg, string img)
        {
            //var mainWindow = Window.GetWindow(this) as Unowhy_Tools_WPF.Views.MainWindow;
            Write2Log("DialogQ: " + msg + " " + img);
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            if (mainWindow.ShowDialogQ(msg, GetImgSource(img)))
            {
                Write2Log("Result: Yes");
                return true;
            }
            else
            {
                Write2Log("Result: No");
                return false;
            }
        }

        public static void DialogIShow(string msg, string img)
        {
            Write2Log("DialogI: " + msg + " " + img);
            var mainWindow = System.Windows.Application.Current.MainWindow as Unowhy_Tools_WPF.Views.MainWindow;
            mainWindow.ShowDialogI(msg, GetImgSource(img));
        }

        public class Data : INotifyPropertyChanged
        {
            public event PropertyChangedEventHandler PropertyChanged;
            protected virtual void OnPropertyChanged([CallerMemberName] string propertyName = null)
            {
                PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
            }

            private static string _hostname;
            private static string _userid;
            private static string _user;
            private static string _sn;
            private static string _mf;
            private static string _md;
            private static string _os;
            private static string _bios;
            private static string _biosv;
            private static string _biosmf;
            private static string _biosd;
            private static string _cpu;
            private static string _ram;
            private static string _sku;
            private static string _mbmf;
            private static string _mbmd;
            private static string _mbv;
            private static string _adminsname;
            private static string _adminname;
            private static string _family;
            private static bool _taskmgr;
            private static bool _locka;
            private static bool _admin;
            private static bool _aad;
            private static bool _aaduser;
            private static bool _bcd;
            private static bool _entuser;
            private static bool _whe;
            private static bool _bim;
            private static bool _shellok;
            private static bool _tistartup;
            private static bool _hsmexist;
            private static bool _hsmenabled;
            private static bool _hsmrunning;
            private static bool _hsmexeexist;
            private static bool _ridffolderexist;
            private static bool _entfolderexist;
            private static bool _oemfolderexist;
            private static bool _tifolderexist;
            private static bool _hsqmfolderexist;
            private static bool _hsqfolderexist;
            private static bool _winre;
            private static bool _camover;
            private static bool _verbstat;
            private static bool _edgeinstalled;
            private static bool _noedgereg;
            private static bool _windefenabled;
            private static bool _ridfcertinstalled;

            private static bool _trayrunok;
            private static bool _runtray;
            private static bool _runconsole;
            private static bool _runupdater;

            private static string _logs;

            public string HostName
            {
                get { return _hostname; }
                set
                {
                    _hostname = value;
                    OnPropertyChanged();
                }
            }
            public string UserID
            {
                get { return _userid; }
                set
                {
                    _userid = value;
                    OnPropertyChanged();
                }
            }
            public string User
            {
                get { return _user; }
                set
                {
                    _user = value;
                    OnPropertyChanged();
                }
            }
            public string sn
            {
                get { return _sn; }
                set
                {
                    _sn = value;
                    OnPropertyChanged();
                }
            }
            public string mf
            {
                get { return _mf; }
                set
                {
                    _mf = value;
                    OnPropertyChanged();
                }
            }
            public string md
            {
                get { return _md; }
                set
                {
                    _md = value;
                    OnPropertyChanged();
                }
            }
            public string os
            {
                get { return _os; }
                set
                {
                    _os = value;
                    OnPropertyChanged();
                }
            }
            public string bios
            {
                get { return _bios; }
                set
                {
                    _bios = value;
                    OnPropertyChanged();
                }
            }
            public string biosv
            {
                get { return _biosv; }
                set
                {
                    _biosv = value;
                    OnPropertyChanged();
                }
            }
            public string biosmf
            {
                get { return _biosmf; }
                set
                {
                    _biosmf = value;
                    OnPropertyChanged();
                }
            }
            public string biosd
            {
                get { return _biosd; }
                set
                {
                    _biosd = value;
                    OnPropertyChanged();
                }
            }
            public string cpu
            {
                get { return _cpu; }
                set
                {
                    _cpu = value;
                    OnPropertyChanged();
                }
            }
            public string ram
            {
                get { return _ram; }
                set
                {
                    _ram = value;
                    OnPropertyChanged();
                }
            }
            public string sku
            {
                get { return _sku; }
                set
                {
                    _sku = value;
                    OnPropertyChanged();
                }
            }
            public string mbmf
            {
                get { return _mbmf; }
                set
                {
                    _mbmf = value;
                    OnPropertyChanged();
                }
            }
            public string mbmd
            {
                get { return _mbmd; }
                set
                {
                    _mbmd = value;
                    OnPropertyChanged();
                }
            }
            public string mbv
            {
                get { return _mbv; }
                set
                {
                    _mbv = value;
                    OnPropertyChanged();
                }
            }
            public string AdminsName
            {
                get { return _adminsname; }
                set
                {
                    _adminsname = value;
                    OnPropertyChanged();
                }
            }
            public string AdminName
            {
                get { return _adminname; }
                set
                {
                    _adminname = value;
                    OnPropertyChanged();
                }
            }
            public string family
            {
                get { return _family; }
                set
                {
                    _family = value;
                    OnPropertyChanged();
                }
            }
            public bool TaskMGR
            {
                get { return _taskmgr; }
                set
                {
                    _taskmgr = value;
                    OnPropertyChanged();
                }
            }
            public bool LockA
            {
                get { return _locka; }
                set
                {
                    _locka = value;
                    OnPropertyChanged();
                }
            }
            public bool Admin
            {
                get { return _admin; }
                set
                {
                    _admin = value;
                    OnPropertyChanged();
                }
            }
            public bool AAD
            {
                get { return _aad; }
                set
                {
                    _aad = value;
                    OnPropertyChanged();
                }
            }
            public bool AADUser
            {
                get { return _aaduser; }
                set
                {
                    _aaduser = value;
                    OnPropertyChanged();
                }
            }
            public bool BCD
            {
                get { return _bcd; }
                set
                {
                    _bcd = value;
                    OnPropertyChanged();
                }
            }
            public bool ENTUser
            {
                get { return _entuser; }
                set
                {
                    _entuser = value;
                    OnPropertyChanged();
                }
            }
            public bool WHE
            {
                get { return _whe; }
                set
                {
                    _whe = value;
                    OnPropertyChanged();
                }
            }
            public bool BIM
            {
                get { return _bim; }
                set
                {
                    _bim = value;
                    OnPropertyChanged();
                }
            }
            public bool ShellOK
            {
                get { return _shellok; }
                set
                {
                    _shellok = value;
                    OnPropertyChanged();
                }
            }
            public bool TIStartup
            {
                get { return _tistartup; }
                set
                {
                    _tistartup = value;
                    OnPropertyChanged();
                }
            }
            public bool HSMExist
            {
                get { return _hsmexist; }
                set
                {
                    _hsmexist = value;
                    OnPropertyChanged();
                }
            }
            public bool HSMEnabled
            {
                get { return _hsmenabled; }
                set
                {
                    _hsmenabled = value;
                    OnPropertyChanged();
                }
            }
            public bool HSMRunning
            {
                get { return _hsmrunning; }
                set
                {
                    _hsmrunning = value;
                    OnPropertyChanged();
                }
            }
            public bool HSMExeExist
            {
                get { return _hsmexeexist; }
                set
                {
                    _hsmexeexist = value;
                    OnPropertyChanged();
                }
            }
            public bool RIDFFolderExist
            {
                get { return _ridffolderexist; }
                set
                {
                    _ridffolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool ENTFolderExist
            {
                get { return _entfolderexist; }
                set
                {
                    _entfolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool OEMFolderExist
            {
                get { return _oemfolderexist; }
                set
                {
                    _oemfolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool TIFolderExist
            {
                get { return _tifolderexist; }
                set
                {
                    _tifolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool HSQMFolderExist
            {
                get { return _hsqmfolderexist; }
                set
                {
                    _hsqmfolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool HSQFolderExist
            {
                get { return _hsqfolderexist; }
                set
                {
                    _hsqfolderexist = value;
                    OnPropertyChanged();
                }
            }
            public bool WinRE
            {
                get { return _winre; }
                set
                {
                    _winre = value;
                    OnPropertyChanged();
                }
            }
            public bool CamOver
            {
                get { return _camover; }
                set
                {
                    _camover = value;
                    OnPropertyChanged();
                }
            }
            public bool VerbStat
            {
                get { return _verbstat; }
                set
                {
                    _verbstat = value;
                    OnPropertyChanged();
                }
            }
            public bool EdgeInstalled
            {
                get { return _edgeinstalled; }
                set
                {
                    _edgeinstalled = value;
                    OnPropertyChanged();
                }
            }
            public bool NoEdgeReg
            {
                get { return _noedgereg; }
                set
                {
                    _noedgereg = value;
                    OnPropertyChanged();
                }
            }
            public bool WinDefEnabled
            {
                get { return _windefenabled; }
                set
                {
                    _windefenabled = value;
                    OnPropertyChanged();
                }
            }
            public bool RIDFCertInstalled
            {
                get { return _ridfcertinstalled; }
                set
                {
                    _ridfcertinstalled = value;
                    OnPropertyChanged();
                }
            }

            public bool TrayRunOK
            {
                get { return _trayrunok; }
                set
                {
                    _trayrunok = value;
                    OnPropertyChanged();
                }
            }
            public bool RunTray
            {
                get { return _runtray; }
                set
                {
                    _runtray = value;
                    OnPropertyChanged();
                }
            }
            public bool RunConsole
            {
                get { return _runconsole; }
                set
                {
                    _runconsole = value;
                    OnPropertyChanged();
                }
            }
            public bool RunUpdater
            {
                get { return _runupdater; }
                set
                {
                    _runupdater = value;
                    OnPropertyChanged();
                }
            }
            public string Logs
            {
                get { return _logs; }
                set
                {
                    _logs = value;
                    OnPropertyChanged();
                }
            }
        }
    }
}
